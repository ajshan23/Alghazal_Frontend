import{r as N,v as ge,a8 as ve,F as xe,j as e}from"./index-BqYC2zCO.js";import{F as je,a as l}from"./FormItem-FeS_vrRF.js";import{B as v}from"./Button-BZH25-Aw.js";import{S as ye}from"./StickyFooter-DDBoG40l.js";import{F as fe,a as Ne,c as Y,b as x}from"./formik.esm-a5N8pODv.js";import{c as Z,g as S,e as ee,f as Ae,b as Q}from"./index.esm-BBYGt9u8.js";import{t as P,N as q}from"./toast-BNCR3rph.js";import{A as C}from"./AdaptableCard-DChiyDM1.js";import{I as u}from"./Input-CF7OdvAt.js";import{$ as te,_ as U}from"./index-CErL3g3x.js";import{D as ae}from"./index-Bm5J6gtn.js";import{S as se}from"./Select-3fyDv9Rf.js";import{g as Pe,u as qe,c as Ce}from"./api-B84bB5PQ.js";import"./context-CKHslMnf.js";import"./index-BLbmKy6n.js";import"./proxy-DBs-aCG0.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-7CwaeXnJ.js";import"./StatusIcon-CrxJz663.js";import"./CloseButton-L6WjsDsk.js";import"./chainedFunction-BxZSneMW.js";import"./Card-DiA6JKLe.js";import"./Views-B3egHxO-.js";import"./toString-sucKyfO-.js";import"./floating-ui.react-DBGHfBho.js";import"./floating-ui.dom-B_iSk-nO.js";import"./useUniqueId-BmsTzdR7.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";const ie=[{value:"nos",label:"Numbers (NOS)"},{value:"ls",label:"Lumpsum (LS)"},{value:"pcs",label:"Pieces (pcs)"},{value:"box",label:"Box (box)"},{value:"kg",label:"Kilogram (kg)"},{value:"l",label:"Liter (L)"},{value:"m",label:"Meter (m)"},{value:"sq_m",label:"Square Meter (m²)"},{value:"sq_ft",label:"Square Foot (ft²)"}],re=[{value:"The work will be started after receiving the PO",label:"The work will be started after receiving the PO"},{value:"The work will be started after the confirmation of client",label:"The work will be started after receiving the PO"}],ne=[{value:"The payment as per accounting terms 90 days",label:"The payment as per accounting terms 90 days"},{value:"The payment as per accounting terms 60 days",label:"The payment as per accounting terms 60 days"},{value:"The payment as per accounting terms 30 days",label:"The payment as per accounting terms 30 days"},{value:"50% advance and 50% after completion of work",label:"50% advance and 50% after completion of work"},{value:"50% advance before starting the work and 30% work on progress and 20% after completion of work",label:"50% advance before starting the work and 30% work on progress and 20% after completion of work"},{value:"Cash on delivery",label:"Cash on delivery"}],we=Z().shape({validUntil:Ae().required("Valid Until date is required"),items:ee().of(Z().shape({description:Q().required("Description is required"),uom:Q().required("Unit of measurement is required"),quantity:S().required("Quantity is required").min(0,"Quantity must be positive"),unitPrice:S().required("Unit price is required").min(0,"Unit price must be positive")})).min(1,"At least one item is required"),termsAndConditions:ee().of(Q().required("Term cannot be empty")).min(1,"At least one term is required"),vatPercentage:S().min(0,"VAT percentage cannot be negative").max(100,"VAT percentage cannot exceed 100")}),ke=N.forwardRef((oe,le)=>{const{onDiscard:ce}=oe,w=ge(),{projectId:j,quotationId:c}=ve(),{state:k}=xe(),T=k==null?void 0:k.estimationId,[me,de]=N.useState({quotationNumber:"",date:new Date,validUntil:new Date(Date.now()+30*24*60*60*1e3),items:[{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}],termsAndConditions:[""],vatPercentage:5,subtotal:0,vatAmount:0,netAmount:0,project:j,estimation:T}),[ue,F]=N.useState(!!c);N.useEffect(()=>{(async()=>{var o,r;if(c&&j)try{F(!0),console.log("Fetching quotation data for:",{quotationId:c,projectId:j});const s=(await Pe(j)).data;if(s._id===c)de({_id:s._id,quotationNumber:s.quotationNumber,date:new Date(s.date),validUntil:new Date(s.validUntil),items:s.items.map(n=>({description:n.description,uom:n.uom,quantity:n.quantity,unitPrice:n.unitPrice,totalPrice:n.totalPrice})),termsAndConditions:s.termsAndConditions.length>0?s.termsAndConditions:[""],vatPercentage:s.vatPercentage,subtotal:s.subtotal,vatAmount:s.vatAmount,netAmount:s.netAmount,project:((o=s.project)==null?void 0:o._id)||j,estimation:((r=s.estimation)==null?void 0:r._id)||T});else throw new Error("Quotation ID mismatch")}catch(d){console.error("Error fetching quotation:",d),P.push(e.jsx(q,{title:"Error",type:"danger",duration:2500,children:"Failed to load quotation data"}),{placement:"top-center"}),w(-1)}finally{F(!1)}})()},[c,j,T,w]);const pe=async a=>{var o,r;try{const d={project:a.project,estimation:a.estimation,validUntil:a.validUntil,scopeOfWork:[],termsAndConditions:a.termsAndConditions,items:a.items,vatPercentage:a.vatPercentage};c?(await qe(c,d),P.push(e.jsx(q,{title:"Success",type:"success",duration:2500,children:"Quotation updated successfully."}),{placement:"top-center"})):(await Ce(d),P.push(e.jsx(q,{title:"Success",type:"success",duration:2500,children:"Quotation created successfully."}),{placement:"top-center"})),w(-1)}catch(d){console.error(`Error ${c?"updating":"creating"} quotation:`,d),P.push(e.jsx(q,{title:"Error",type:"danger",duration:2500,children:((r=(o=d.response)==null?void 0:o.data)==null?void 0:r.message)||`Failed to ${c?"update":"create"} quotation. Please try again.`}),{placement:"top-center"})}},he=c?"Edit Quotation":"Create Quotation",be=c?"Update Quotation":"Create Quotation";return ue?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:he}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:c?"Edit existing quotation":"Create a new quotation"})]}),e.jsx(fe,{innerRef:le,initialValues:me,validationSchema:we,onSubmit:pe,enableReinitialize:!0,children:({values:a,touched:o,errors:r,isSubmitting:d,setFieldValue:s})=>(N.useEffect(()=>{a.items.forEach((i,p)=>{const b=parseFloat((i.quantity*i.unitPrice).toFixed(2));i.totalPrice!==b&&s(`items[${p}].totalPrice`,b)});const n=a.items.reduce((i,p)=>i+p.totalPrice,0);a.subtotal!==n&&s("subtotal",n);const m=parseFloat((n*(a.vatPercentage/100)).toFixed(2)),t=parseFloat((n+m).toFixed(2));a.vatAmount!==m&&s("vatAmount",m),a.netAmount!==t&&s("netAmount",t)},[a.items,a.vatPercentage]),e.jsx(Ne,{children:e.jsxs(je,{children:[e.jsxs(C,{divider:!0,className:"mb-6",children:[e.jsx("h5",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4",children:"Quotation Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(l,{label:"Quotation Number",className:"mb-0",children:e.jsx(u,{readOnly:!0,value:a.quotationNumber||"Auto-generated",placeholder:"Auto-generated"})}),e.jsx(l,{label:"Date",className:"mb-0",children:e.jsx(ae,{placeholder:"Select date",value:a.date,onChange:n=>{s("date",n)},inputClass:"h-11"})}),e.jsx(l,{label:"Valid Until *",invalid:!!r.validUntil&&o.validUntil,errorMessage:r.validUntil,className:"mb-0",children:e.jsx(ae,{placeholder:"Select date",value:a.validUntil,onChange:n=>{s("validUntil",n)},inputClass:"h-11"})})]})]}),e.jsxs(C,{divider:!0,className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h5",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Quotation Items"}),e.jsx(v,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(te,{}),onClick:()=>{s("items",[...a.items,{description:"",uom:"",quantity:0,unitPrice:0,totalPrice:0}])},children:"Add Item"})]}),e.jsx(Y,{name:"items",children:({remove:n})=>e.jsx("div",{className:"space-y-4",children:a.items.map((m,t)=>{var i,p,b,y,A,g,$,D,I,O,E,M,z,_,L,B,R,H,K,W,G,J,V,X;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4 items-end p-4 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsx("div",{className:"md:col-span-4",children:e.jsx(l,{label:`Item ${t+1}`,invalid:!!((p=(i=r.items)==null?void 0:i[t])!=null&&p.description)&&((y=(b=o.items)==null?void 0:b[t])==null?void 0:y.description),errorMessage:(g=(A=r.items)==null?void 0:A[t])==null?void 0:g.description,className:"mb-0",children:e.jsx(x,{as:u,name:`items[${t}].description`,placeholder:"Description",value:m.description,textArea:!0,rows:2})})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(l,{label:"UOM",invalid:!!((D=($=r.items)==null?void 0:$[t])!=null&&D.uom)&&((O=(I=o.items)==null?void 0:I[t])==null?void 0:O.uom),errorMessage:(M=(E=r.items)==null?void 0:E[t])==null?void 0:M.uom,className:"mb-0",children:e.jsx(x,{name:`items[${t}].uom`,children:({field:f})=>e.jsx(se,{options:ie,value:ie.find(h=>h.value===f.value)||null,onChange:h=>{s(`items[${t}].uom`,(h==null?void 0:h.value)||"")},placeholder:"Select unit"})})})}),e.jsx("div",{className:"md:col-span-1",children:e.jsx(l,{label:"Qty",invalid:!!((_=(z=r.items)==null?void 0:z[t])!=null&&_.quantity)&&((B=(L=o.items)==null?void 0:L[t])==null?void 0:B.quantity),errorMessage:(H=(R=r.items)==null?void 0:R[t])==null?void 0:H.quantity,className:"mb-0",children:e.jsx(x,{type:"number",name:`items[${t}].quantity`,placeholder:"Quantity",component:u,min:0,step:"any",value:m.quantity||"",onChange:f=>{const h=parseFloat(f.target.value)||0;s(`items[${t}].quantity`,h)}})})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(l,{label:"Unit Price",invalid:!!((W=(K=r.items)==null?void 0:K[t])!=null&&W.unitPrice)&&((J=(G=o.items)==null?void 0:G[t])==null?void 0:J.unitPrice),errorMessage:(X=(V=r.items)==null?void 0:V[t])==null?void 0:X.unitPrice,className:"mb-0",children:e.jsx(x,{type:"number",name:`items[${t}].unitPrice`,placeholder:"Unit price",component:u,min:0,value:m.unitPrice||"",onChange:f=>{const h=parseFloat(f.target.value)||0;s(`items[${t}].unitPrice`,h)}})})}),e.jsx("div",{className:"md:col-span-2",children:e.jsx(l,{label:"Total",className:"mb-0",children:e.jsx(u,{readOnly:!0,value:(m.quantity*m.unitPrice).toFixed(2),placeholder:"Total",className:"font-semibold"})})}),e.jsx("div",{className:"md:col-span-1",children:e.jsx(v,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),onClick:()=>n(t)})})]},t)})})})]}),e.jsxs(C,{divider:!0,className:"mb-6",children:[e.jsx("h5",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4",children:"Terms & Conditions"}),e.jsx(Y,{name:"termsAndConditions",children:({push:n,remove:m})=>e.jsxs("div",{className:"space-y-4",children:[a.termsAndConditions.map((t,i)=>{var p,b,y;return e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(l,{className:"flex-grow mb-0",invalid:!!((p=r.termsAndConditions)!=null&&p[i])&&((b=o.termsAndConditions)==null?void 0:b[i]),errorMessage:(y=r.termsAndConditions)==null?void 0:y[i],children:i<2?e.jsx(x,{name:`termsAndConditions[${i}]`,children:({field:A})=>e.jsx(se,{options:i===0?re:ne,value:(i===0?re:ne).find(g=>g.value===A.value)||null,onChange:g=>{s(`termsAndConditions[${i}]`,(g==null?void 0:g.value)||"")},placeholder:i===0?"Select work start term":"Select payment term"})}):e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{as:u,name:`termsAndConditions[${i}]`,placeholder:"Additional term or condition",value:t}),e.jsx(v,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),onClick:()=>m(i),className:"mt-2"})]})}),i<2&&e.jsx(v,{type:"button",size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),onClick:()=>m(i),className:"mt-2"})]},i)}),e.jsx("div",{className:"flex justify-center mt-4",children:e.jsx(v,{type:"button",size:"sm",variant:"twoTone",icon:e.jsx(te,{}),onClick:()=>n(""),children:"Add Term"})})]})})]}),e.jsxs(C,{divider:!0,className:"mb-6",children:[e.jsx("h5",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4",children:"Financial Summary"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(l,{label:"Subtotal",className:"mb-0",children:e.jsx(u,{readOnly:!0,value:a.subtotal.toFixed(2),placeholder:"Subtotal",className:"font-semibold"})}),e.jsx(l,{label:"VAT Percentage",invalid:!!r.vatPercentage&&o.vatPercentage,errorMessage:r.vatPercentage,className:"mb-0",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(x,{as:u,type:"number",name:"vatPercentage",placeholder:"VAT percentage",min:0,max:100,value:a.vatPercentage,className:"flex-grow"}),e.jsx("span",{className:"ml-2 text-gray-500",children:"%"})]})}),e.jsx(l,{label:"VAT Amount",className:"mb-0",children:e.jsx(u,{readOnly:!0,value:a.vatAmount.toFixed(2),placeholder:"VAT amount",className:"font-semibold"})}),e.jsx(l,{label:"Net Amount",className:"mb-0",children:e.jsx(u,{readOnly:!0,value:a.netAmount.toFixed(2),placeholder:"Net amount",className:"font-semibold text-blue-600 dark:text-blue-400"})})]})]}),e.jsxs(ye,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:e.jsx(v,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:ce,children:"Discard"})}),e.jsx("div",{className:"md:flex grid-2 gap-2",children:e.jsx(v,{size:"sm",variant:"solid",loading:d,type:"submit",children:be})})]})]})}))})]})});ke.displayName="QuotationForm";export{ke as default};
