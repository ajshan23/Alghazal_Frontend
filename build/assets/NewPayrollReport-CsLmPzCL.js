import{r as y,j as e,v as K,a8 as H}from"./index-CZ-QxqVN.js";import{N as k,t as A}from"./toast-CoCmtbLn.js";import{K as Y,n as G,L as Q,M as W,N as X}from"./api-CU6E8JBH.js";import{F as Z,a as n}from"./FormItem-BFRIpM45.js";import{B as L}from"./Button-wTWRjSOp.js";import{S as F}from"./StickyFooter-K7CPbFFZ.js";import{F as V,a as ee,b as h}from"./formik.esm-BJAcCTJf.js";import{A as re}from"./index-Dv3L-RrQ.js";import{_ as ae}from"./index-kD3pbGz6.js";import{c as oe,b as d}from"./index.esm-3ESt5Gw2.js";import"./Alert-vZZK0s39.js";import"./index-DdzAiQaI.js";import"./Badge-M_R8BM5O.js";import"./index-WCrMc_mB.js";import"./Card-DYSpZm-g.js";import"./index-Dhhfgcmn.js";import"./Dialog-5Q7WvFhs.js";import"./Drawer-Cgxg1eSD.js";import"./index-BRrKuFuY.js";import"./useUniqueId-BHonA5r7.js";import{I as p}from"./Input-C15wo5ys.js";import"./Upload-CNTsixo0.js";import"./index-Cee-dHef.js";import"./index-CUYy2E4V.js";import"./ScrollBar-CX8t2iP4.js";import{S as te}from"./Select-ukccBfLg.js";import"./Tag-gTkDLVan.js";import{A as B}from"./AdaptableCard-Ce_KsDG0.js";import"./Views-BmihdypO.js";import"./SvgIcon-tuMtLRs6.js";import"./DataTable-C-dnd2Pg.js";import"./StatusIcon-D9-As4b9.js";import"./CloseButton-DDicOJ3W.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-D7sJR9rS.js";import"./context-B6r7oiwN.js";import"./index-cPHdE-6C.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-C_KtrfhP.js";import"./floating-ui.react-B1qnMOd0.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-lWKxFJo-.js";import"./index-DzN3DWMt.js";import"./index-CFpcu7wG.js";import"./toString-DttkkGgf.js";import"./index-D2JWHt9J.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-rxUVokHK.js";const J=y.forwardRef((x,l)=>{const{type:g,initialData:C={employee:"",labourCard:"",labourCardPersonalNo:"",period:"",basic:"0",allowance:"0",otOvertime:"0",deduction:"0",mess:"0",advance:"0",net:"0",remark:""},onFormSubmit:E,onDiscard:f,onDelete:v}=x,[j,q]=y.useState([]);y.useEffect(()=>{(async()=>{var t;try{const c=(t=(await G()).data)==null?void 0:t.users.map(r=>({value:r._id,label:`${r.firstName} ${r.lastName}`}));q(c)}catch(a){console.error("Failed to fetch users",a)}})()},[]);const R=oe().shape({employee:d().required("Employee name is required"),labourCard:d().required("Labour Card is required"),labourCardPersonalNo:d().required("Labour Card Personal No is required"),period:d().required("Period is required"),basic:d().required("Basic salary is required"),allowance:d().required("Allowance is required"),otOvertime:d(),deduction:d().required("Deduction is required"),mess:d().required("Mess is required"),advance:d().required("Advance is required"),net:d().required("Net is required"),remark:d().max(500,"Remark must be at most 500 characters")});return e.jsx(V,{innerRef:l,initialValues:C,validationSchema:R,onSubmit:async(s,{setSubmitting:t,setErrors:a})=>{var c,r;try{await E(s,t)}catch(u){t(!1),(r=(c=u.response)==null?void 0:c.data)!=null&&r.errors&&a(u.response.data.errors),console.error("Form submission error:",u)}},enableReinitialize:!0,children:({values:s,touched:t,errors:a,isSubmitting:c,setFieldValue:r,handleBlur:u,resetForm:i})=>{const b=parseFloat(s.basic)||0,N=parseFloat(s.allowance)||0,w=parseFloat(s.otOvertime)||0,P=parseFloat(s.deduction)||0,O=parseFloat(s.mess)||0,S=parseFloat(s.advance)||0,T=b+N+w,_=P+O+S,D=T-_;return y.useEffect(()=>{r("net",D.toFixed(2))},[b,N,w,P,O,S,D,r]),e.jsx(ee,{children:e.jsxs(Z,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(B,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Employee Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4",children:[e.jsx(n,{label:"EMPLOYEE",invalid:!!a.employee,errorMessage:a.employee,children:e.jsx(te,{name:"employee",placeholder:"Select user",value:j.find(o=>o.value===s.employee),options:j,onChange:async o=>{var U,$;const M=(o==null?void 0:o.value)||"";if(r("employee",M),M)try{const m=(await Y(M)).data;r("basic",((U=m==null?void 0:m.employee)==null?void 0:U.basicSalary)||"0"),r("otOvertime",(($=m==null?void 0:m.overtime)==null?void 0:$.previousMonthTotal)||"0"),r("allowance","0"),r("deduction","0"),r("mess","0"),r("advance","0"),m!=null&&m.visaDetails?(r("labourCard",m.visaDetails.labourCardPersonalNumber||""),r("labourCardPersonalNo",m.visaDetails.workPermitNumber||"")):(r("labourCard",""),r("labourCardPersonalNo",""))}catch(z){console.error("Failed to fetch employee details",z),r("basic","0"),r("otOvertime","0"),r("allowance","0"),r("deduction","0"),r("mess","0"),r("advance","0"),r("labourCard",""),r("labourCardPersonalNo","")}else r("labourCard",""),r("labourCardPersonalNo",""),r("basic","0"),r("otOvertime","0"),r("allowance","0"),r("deduction","0"),r("mess","0"),r("advance","0")},onBlur:u})}),e.jsx(n,{label:"LABOUR CARD",invalid:!!a.labourCard,errorMessage:a.labourCard,children:e.jsx(h,{name:"labourCard",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"LabourCard",...o,readOnly:!0})})}),e.jsx(n,{label:"LABOUR CARD PERSONAL NO",invalid:!!a.labourCardPersonalNo,errorMessage:a.labourCardPersonalNo,children:e.jsx(h,{name:"labourCardPersonalNo",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Labour Card PersonalNo",...o,readOnly:!0})})}),e.jsx(n,{label:"PERIOD",invalid:!!a.period,errorMessage:a.period,children:e.jsx(h,{name:"period",children:({field:o})=>e.jsx(p,{autoComplete:"off",placeholder:"e.g. January 2023",...o})})})]})]}),e.jsxs(B,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Salary Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(n,{label:"Basic salary",children:e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Basic Salary",value:s.basic,readOnly:!0})}),e.jsx(n,{label:"Allowance",invalid:!!a.allowance&&t.allowance,errorMessage:a.allowance,children:e.jsx(h,{name:"allowance",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Allowance",...o})})}),e.jsx(n,{label:"Overtime",invalid:!!a.otOvertime&&t.otOvertime,errorMessage:a.otOvertime,children:e.jsx(h,{name:"otOvertime",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Overtime",...o,readOnly:!0})})}),e.jsx(n,{label:"Deduction",invalid:!!a.deduction&&t.deduction,errorMessage:a.deduction,children:e.jsx(h,{name:"deduction",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Deduction",...o})})}),e.jsx(n,{label:"Mess",invalid:!!a.mess&&t.mess,errorMessage:a.mess,children:e.jsx(h,{name:"mess",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Mess",...o})})}),e.jsx(n,{label:"Advance",invalid:!!a.advance&&t.advance,errorMessage:a.advance,children:e.jsx(h,{name:"advance",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Advance",...o})})}),e.jsx(n,{label:"Net",invalid:!!a.net&&t.net,errorMessage:a.net,children:e.jsx(h,{name:"net",children:({field:o})=>e.jsx(p,{type:"text",autoComplete:"off",placeholder:"Net",...o,readOnly:!0})})})]})]}),e.jsxs(B,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(n,{label:"REMARK",invalid:!!a.remark&&t.remark,errorMessage:a.remark,children:e.jsx(h,{name:"remark",children:({field:o})=>e.jsx(p,{as:"textarea",autoComplete:"off",placeholder:"Enter remarks",...o})})})]})]})}),e.jsxs(F,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:g==="edit"&&v&&e.jsx(L,{size:"sm",variant:"plain",color:"red",icon:e.jsx(ae,{}),type:"button",onClick:()=>v(o=>{o&&i()}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(L,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>{i(),f==null||f()},children:"Discard"}),e.jsx(L,{size:"sm",variant:"solid",loading:c,icon:e.jsx(re,{}),type:"submit",children:"Save"})]})]})]})})}})});J.displayName="PayrollForm";const I={name:"",labourCard:"",labourCardPersonalNo:"",period:"",allowance:"",deduction:"",mess:"",advance:"",net:"",remark:""},er=()=>{const x=K(),{id:l}=H(),[g,C]=y.useState(I),[E,f]=y.useState(!!l),[v,j]=y.useState(null);y.useEffect(()=>{if(!l){C(I),f(!1);return}(async()=>{try{f(!0);const t=await Q(l);if(!(t!=null&&t.data))throw new Error("Invalid payroll data received");const{employee:a,labourCard:c,labourCardPersonalNo:r,basic:u,period:i,allowance:b,deduction:N,mess:w,advance:P,net:O,remark:S}=t.data;C({employee:(a==null?void 0:a._id)||"",labourCard:c||"",labourCardPersonalNo:r||"",basic:u||"",period:i||"",allowance:b||"",deduction:N||"",mess:w||"",advance:P||"",net:O||"",remark:S||""}),j(null)}catch(t){console.error("Error fetching payroll report:",t),j(t.message||"Failed to load payroll data"),A.push(e.jsx(k,{title:"Failed to fetch payroll report data",type:"danger",duration:2500,children:t.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>x("/app/payroll-view"),2500)}finally{f(!1)}})()},[l,x]);const q=async(s,t)=>{var a,c,r,u;try{t(!0);const i={employee:s.employee,labourCard:s.labourCard,labourCardPersonalNo:s.labourCardPersonalNo,period:s.period,allowance:s.allowance,deduction:s.deduction,mess:s.mess,advance:s.advance,net:s.net,remark:s.remark},b=l?await W(l,i):await X(i);if([200,201].includes(b.status))A.push(e.jsxs(k,{title:`Successfully ${l?"updated":"added"} payroll report`,type:"success",duration:2500,children:["Payroll report ",l?"updated":"added"," successfully"]}),{placement:"top-center"}),x("/app/payroll-report-view");else throw new Error(((c=(a=b==null?void 0:b.response)==null?void 0:a.data)==null?void 0:c.message)||"Unexpected status code")}catch(i){console.error("Form submission error:",i),A.push(e.jsx(k,{title:`Error ${l?"updating":"adding"} payroll report`,type:"danger",duration:2500,children:((u=(r=i==null?void 0:i.response)==null?void 0:r.data)==null?void 0:u.message)||i.message}),{placement:"top-center"})}finally{t(!1)}},R=()=>{JSON.stringify(g)!==JSON.stringify(I)?window.confirm("Are you sure you want to discard changes?")&&x("/app/payroll-view"):x("/app/payroll-view")};return E?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):v?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(k,{title:"Error loading payroll report",type:"danger",children:v})}):e.jsx(J,{type:l?"edit":"new",initialData:g,onFormSubmit:q,onDiscard:R})};export{er as default};
