import{r as p,j as e,v as ge,a8 as be}from"./index-DGJe0h3_.js";import{N as R,t as Y}from"./toast-DO-2lc6K.js";import{F as fe,a as y}from"./FormItem-CS5k__-u.js";import{B as z}from"./Button-CQnyK8gC.js";import{S as ye}from"./StickyFooter-B-P65R3j.js";import{F as xe,a as ve,b as x}from"./formik.esm-Bd7bPKfV.js";import{A as je}from"./index-CRCxGWKG.js";import{_ as ae}from"./index-DB0cxP-C.js";import{c as Se,h as Ne,b as k,g as Me,f as Ce}from"./index.esm-Kw287qmC.js";import"./Alert-DQXwajGW.js";import"./index-BoJTJILF.js";import"./Badge-Bbo5QMXa.js";import{D as ke}from"./index-CIbY2fIk.js";import"./Card-BM0eEatX.js";import"./index-BGu1WFOe.js";import"./Dialog-Cg-T3Ihd.js";import"./Drawer-CLVcPT2Q.js";import"./index-Bv5Pt-_w.js";import"./useUniqueId-D1PCBCG9.js";import{I as G}from"./Input-k-NORbeb.js";import"./Upload-BgdP_nuh.js";import"./index-1STGvrfH.js";import"./index-nUD77ZMI.js";import"./ScrollBar-nZR6U59l.js";import{S as q}from"./Select-C04L81V4.js";import"./Tag-BPJKpn67.js";import{A as L}from"./AdaptableCard-BnEcGD7j.js";import"./Views-BFlyERhL.js";import"./SvgIcon-BuJBiwVw.js";import"./DataTable-CLMBeNRf.js";import{k as te,l as le,o as we,p as Be,q as Ae}from"./api-BtuCWMnW.js";import{l as se}from"./lodash-CYz9bQJE.js";import{f as Fe}from"./format-CBpsKyOP.js";import"./StatusIcon-BdTPNP40.js";import"./CloseButton-CGoFVruc.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-BoP70aqV.js";import"./context-DBc_qd6o.js";import"./index-C4_xw0Qz.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-DodG7NJv.js";import"./floating-ui.react-DD89AqSX.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-0ulQvO4z.js";import"./index-Blf2GdN6.js";import"./index-CXaN8JhO.js";import"./toString-Dkf6_Dxj.js";import"./index-TU9pDyqH.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-CWxsYH8M.js";import"./index-BX8TTJWs.js";const ie=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"mashreq_card"},{label:"CREDIT",value:"credit"},{label:"ADCB CARD",value:"adcb_card"},{label:"ADCB BANK",value:"adcb_bank"},{label:"MASHREQ BANK",value:"mashreq_bank"},{label:"OWNER PERSONAL PAY",value:"owner_personal_pay"},{label:"MR.SYED PAY",value:"mr_syed_pay"},{label:"OTHER PAY",value:"other_pay"},{label:"CHEQUE",value:"cheque"},{label:"WIO CARD",value:"wio_card"},{label:"WIO BANK",value:"wio_bank"}],Pe=new Date,re=p.forwardRef((v,g)=>{const{type:w,initialData:u={billType:"general",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,category:"",shop:"",invoiceNo:"",remarks:"",attachments:[]},onFormSubmit:$,onDiscard:j,onDelete:B}=v,[M,A]=p.useState([]),[_,S]=p.useState([]),[C,N]=p.useState(!0),[n,F]=p.useState(!1),[P,b]=p.useState(""),[E,Q]=p.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),[U,V]=p.useState([]),[H,W]=p.useState(!1),[J,oe]=p.useState(""),[T,X]=p.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),Z=p.useCallback(se.debounce(async(s,o=1)=>{var r;try{F(!0);const l=await te(s,o,E.limit),d=(r=l==null?void 0:l.data)==null?void 0:r.shops.map(i=>({label:i.shopName,value:i._id}));S(o===1?d||[]:i=>[...i,...d||[]]),Q(i=>{var a,c,t,h,m,f;return{...i,page:o,total:((c=(a=l==null?void 0:l.data)==null?void 0:a.pagination)==null?void 0:c.total)||0,totalPages:((h=(t=l==null?void 0:l.data)==null?void 0:t.pagination)==null?void 0:h.totalPages)||0,hasMore:o<(((f=(m=l==null?void 0:l.data)==null?void 0:m.pagination)==null?void 0:f.totalPages)||0)}})}catch(l){console.error("Error searching shops:",l)}finally{F(!1)}},500),[E.limit]),ee=p.useCallback(se.debounce(async(s,o=1)=>{var r;try{W(!0);const l=await le(s,o,T.limit),d=(r=l==null?void 0:l.data)==null?void 0:r.categories.map(i=>({label:i.name,value:i._id}));V(o===1?d||[]:i=>[...i,...d||[]]),X(i=>{var a,c,t,h,m,f;return{...i,page:o,total:((c=(a=l==null?void 0:l.data)==null?void 0:a.pagination)==null?void 0:c.total)||0,totalPages:((h=(t=l==null?void 0:l.data)==null?void 0:t.pagination)==null?void 0:h.totalPages)||0,hasMore:o<(((f=(m=l==null?void 0:l.data)==null?void 0:m.pagination)==null?void 0:f.totalPages)||0)}})}catch(l){console.error("Error searching categories:",l)}finally{W(!1)}},500),[T.limit]);p.useEffect(()=>{u.attachments&&A(u.attachments)},[u]),p.useEffect(()=>{(async()=>{var o,r,l;try{const d=await te("",1,E.limit),i=(o=d==null?void 0:d.data)==null?void 0:o.shops.map(t=>({label:t.shopName,value:t._id}));S(i||[]),Q(t=>{var h,m,f,O,D,I;return{...t,total:((m=(h=d==null?void 0:d.data)==null?void 0:h.pagination)==null?void 0:m.total)||0,totalPages:((O=(f=d==null?void 0:d.data)==null?void 0:f.pagination)==null?void 0:O.totalPages)||0,hasMore:1<(((I=(D=d==null?void 0:d.data)==null?void 0:D.pagination)==null?void 0:I.totalPages)||0)}});const a=await le("",1,T.limit),c=(l=(r=a==null?void 0:a.data)==null?void 0:r.categories)==null?void 0:l.map(t=>({label:t.name,value:t._id}));V(c||[]),X(t=>{var h,m,f,O,D,I;return{...t,total:((m=(h=a==null?void 0:a.data)==null?void 0:h.pagination)==null?void 0:m.total)||0,totalPages:((O=(f=a==null?void 0:a.data)==null?void 0:f.pagination)==null?void 0:O.totalPages)||0,hasMore:1<(((I=(D=a==null?void 0:a.data)==null?void 0:D.pagination)==null?void 0:I.totalPages)||0)}})}catch(d){console.error("Failed to load data:",d)}finally{N(!1)}})()},[]);const ne=s=>(b(s),Z(s,1),s),de=()=>{if(E.hasMore&&!n){const s=E.page+1;Z(P,s)}},ce=s=>(oe(s),ee(s,1),s),me=()=>{if(T.hasMore&&!H){const s=T.page+1;ee(J,s)}},pe=Se().shape({billType:k().required("Bill type is required"),billDate:Ce().required("Bill date is required").typeError("Please select a valid date"),paymentMethod:k().required("Payment method is required"),amount:Me().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),category:k().required("Category is required"),shop:k().required("Shop is required"),invoiceNo:k(),remarks:k().max(500,"Remarks must be at most 500 characters"),attachments:Ne()}),he=s=>{if(s.target.files&&s.target.files.length>0){const o=Array.from(s.target.files);A(r=>[...r,...o])}},ue=s=>{A(o=>o.filter((r,l)=>l!==s))};return e.jsx(xe,{innerRef:g,initialValues:{billType:u.billType||"general",billDate:u.billDate||"",paymentMethod:u.paymentMethod||"",amount:u.amount||"",category:u.category||"",shop:u.shop||"",invoiceNo:u.invoiceNo||"",remarks:u.remarks||"",attachments:u.attachments||[]},validationSchema:pe,onSubmit:async(s,{setSubmitting:o,setErrors:r})=>{var l,d;try{const i=new FormData;i.append("billType",s.billType),i.append("billDate",s.billDate),i.append("paymentMethod",s.paymentMethod),i.append("amount",s.amount.toString()),i.append("category",s.category),i.append("shop",s.shop),i.append("invoiceNo",s.invoiceNo),i.append("remarks",s.remarks||""),M.forEach((a,c)=>{a instanceof File?i.append("attachments",a):typeof a=="string"&&w==="edit"&&i.append(`existingAttachments[${c}]`,a)}),await $(i,o)}catch(i){o(!1),(d=(l=i.response)==null?void 0:l.data)!=null&&d.errors&&r(i.response.data.errors),console.error("Form submission error:",i)}},enableReinitialize:!0,children:({values:s,touched:o,errors:r,isSubmitting:l,setFieldValue:d,handleBlur:i})=>e.jsx(ve,{children:e.jsxs(fe,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Bill Type",invalid:!!r.billType&&o.billType,errorMessage:r.billType,children:e.jsx(x,{name:"billType",children:({field:a,form:c})=>{const t=[{label:"General",value:"general",disabled:!0}],h=t.find(m=>m.value===a.value)||t[0];return e.jsx(q,{options:t,value:h,isOptionDisabled:m=>m.disabled,onChange:m=>{c.setFieldValue(a.name,m==null?void 0:m.value)},onBlur:a.onBlur,name:a.name})}})}),e.jsx(y,{label:"Bill Date",invalid:!!r.billDate&&o.billDate,children:e.jsx(x,{name:"billDate",children:({field:a,form:c})=>e.jsx(ke,{placeholder:"Select billDate Date",value:a.value?new Date(a.value):null,maxDate:Pe,onChange:t=>c.setFieldValue(a.name,t?Fe(new Date(t.getFullYear(),t.getMonth(),t.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(y,{label:"Payment Method",invalid:!!r.paymentMethod&&o.paymentMethod,errorMessage:r.paymentMethod,children:e.jsx(x,{name:"paymentMethod",children:({field:a,form:c})=>e.jsx(q,{placeholder:"Select Payment Method",options:ie,value:ie.find(t=>t.value===s.paymentMethod),onChange:t=>{c.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur})})}),e.jsx(y,{label:"Amount",invalid:!!r.amount&&o.amount,errorMessage:r.amount,children:e.jsx(x,{name:"amount",children:({field:a,form:c})=>e.jsx(G,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:t=>{c.setFieldValue(a.name,t.target.value)}})})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Category",invalid:!!r.category&&o.category,errorMessage:r.category,children:e.jsx(x,{name:"category",children:({field:a,form:c})=>e.jsx(q,{placeholder:"Select Category",options:U,value:U.find(t=>t.value===s.category),onChange:t=>{c.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur,loading:H,isSearchable:!0,onInputChange:ce,inputValue:J,onMenuScrollToBottom:me,noOptionsMessage:()=>H?"Loading...":"No categories found",loadingMessage:()=>"Loading categories..."})})}),e.jsx(y,{label:"Shop",invalid:!!r.shop&&o.shop,errorMessage:r.shop,children:e.jsx(x,{name:"shop",children:({field:a,form:c})=>e.jsx(q,{placeholder:"Select Shop",options:_,value:_.find(t=>t.value===s.shop),onChange:t=>{c.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur,loading:n,isSearchable:!0,onInputChange:ne,inputValue:P,onMenuScrollToBottom:de,noOptionsMessage:()=>n?"Loading...":"No shops found",loadingMessage:()=>"Loading shops..."})})}),e.jsx(y,{label:"Invoice Number",invalid:!!r.invoiceNo&&o.invoiceNo,errorMessage:r.invoiceNo,children:e.jsx(x,{name:"invoiceNo",children:({field:a})=>e.jsx(G,{type:"text",autoComplete:"off",placeholder:"Invoice Number",...a})})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(y,{label:"Attachments",invalid:!!r.attachments&&o.attachments,errorMessage:r.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:he,onBlur:()=>i({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500
                                                file:mr-4 file:py-2 file:px-4
                                                file:rounded-md file:border-0
                                                file:text-sm file:font-semibold
                                                file:bg-blue-50 file:text-blue-700
                                                hover:file:bg-blue-100
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),M.length>0&&e.jsx("div",{className:"space-y-2",children:M.map((a,c)=>{const t=a instanceof File,h=t?a.name:a.fileName,m=t?void 0:a.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[m?e.jsx("a",{href:m,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:h}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:h}),e.jsx("button",{type:"button",onClick:()=>ue(c),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(ae,{})})]},c)})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(y,{label:"Remarks",invalid:!!r.remarks&&o.remarks,errorMessage:r.remarks,children:e.jsx(x,{name:"remarks",children:({field:a})=>e.jsx(G,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...a})})})]})]})}),e.jsxs(ye,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:w==="edit"&&B&&e.jsx(z,{size:"sm",variant:"plain",color:"red",icon:e.jsx(ae,{}),type:"button",onClick:()=>B(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(z,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(z,{size:"sm",variant:"solid",loading:l,icon:e.jsx(je,{}),type:"submit",children:"Save"})]})]})]})})})});re.displayName="GenBillForm";const K={billType:"general",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,category:"",shop:"",invoiceNo:"",remarks:"",attachments:[]},Fa=()=>{const v=ge(),{id:g}=be(),[w,u]=p.useState(K),[$,j]=p.useState(!!g),[B,M]=p.useState(null);p.useEffect(()=>{if(!g){u(K),j(!1);return}(async()=>{var C,N;try{j(!0);const n=await we(g);if(!(n!=null&&n.data))throw new Error("Invalid bill data received");u({billType:n.data.billType||"general",billDate:n.data.billDate||new Date().toISOString().split("T")[0],paymentMethod:n.data.paymentMethod||"",amount:n.data.amount||0,category:((C=n.data.category)==null?void 0:C._id)||n.data.category||"",shop:((N=n.data.shop)==null?void 0:N._id)||n.data.shop||"",invoiceNo:n.data.invoiceNo||"",remarks:n.data.remarks||"",attachments:n.data.attachments||[]}),M(null)}catch(n){console.error("Error fetching bill:",n),M(n.message||"Failed to load bill data"),Y.push(e.jsx(R,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:n.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>v("/app/bill-view"),2500)}finally{j(!1)}})()},[g,v]);const A=async(S,C)=>{var N,n,F,P;try{C(!0);const b=g?await Be(g,S):await Ae(S);if([200,201].includes(b.status))Y.push(e.jsxs(R,{title:`Successfully ${g?"updated":"added"} bill`,type:"success",duration:2500,children:["Bill ",g?"updated":"added"," successfully"]}),{placement:"top-center"}),v("/app/bill-view");else throw new Error(((n=(N=b==null?void 0:b.response)==null?void 0:N.data)==null?void 0:n.message)||"Unexpected status code")}catch(b){console.error("Error during form submission:",b),Y.push(e.jsx(R,{title:`Error ${g?"updating":"adding"} bill`,type:"danger",duration:2500,children:((P=(F=b==null?void 0:b.response)==null?void 0:F.data)==null?void 0:P.message)||b.message}),{placement:"top-center"})}finally{C(!1)}},_=()=>{JSON.stringify(w)!==JSON.stringify(K)?window.confirm("Are you sure you want to discard changes?")&&v("/app/bill-view"):v("/app/bill-view")};return $?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):B?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(R,{title:"Error loading bill",type:"danger",children:B})}):e.jsx(re,{type:g?"edit":"new",initialData:w,onFormSubmit:A,onDiscard:_})};export{Fa as default};
