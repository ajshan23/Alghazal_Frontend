import{r as d,j as e,v as Z,a8 as ee}from"./index-CZ-QxqVN.js";import{N as B,t as T}from"./toast-CoCmtbLn.js";import{F as te,a as S}from"./FormItem-BFRIpM45.js";import{B as q}from"./Button-wTWRjSOp.js";import{S as ae}from"./StickyFooter-K7CPbFFZ.js";import{F as se,a as le,b as M}from"./formik.esm-BJAcCTJf.js";import{A as ie}from"./index-Dv3L-RrQ.js";import{_ as U}from"./index-kD3pbGz6.js";import{c as oe,g as re,b as I}from"./index.esm-3ESt5Gw2.js";import"./Alert-vZZK0s39.js";import"./index-DdzAiQaI.js";import"./Badge-M_R8BM5O.js";import{D as ne}from"./index-WCrMc_mB.js";import"./Card-DYSpZm-g.js";import"./index-Dhhfgcmn.js";import"./Dialog-5Q7WvFhs.js";import"./Drawer-Cgxg1eSD.js";import"./index-BRrKuFuY.js";import"./useUniqueId-BHonA5r7.js";import{I as H}from"./Input-C15wo5ys.js";import"./Upload-CNTsixo0.js";import"./index-Cee-dHef.js";import"./index-CUYy2E4V.js";import"./ScrollBar-CX8t2iP4.js";import{S as _}from"./Select-ukccBfLg.js";import"./Tag-gTkDLVan.js";import{A as $}from"./AdaptableCard-Ce_KsDG0.js";import"./Views-BmihdypO.js";import"./SvgIcon-tuMtLRs6.js";import{C as me}from"./ConfirmDialog-m53FmWqq.js";import"./DataTable-C-dnd2Pg.js";import{k as Y,o as de,p as ce,q as pe}from"./api-CU6E8JBH.js";import{l as he}from"./lodash-CXwz2MO0.js";import{f as ue}from"./format-CBpsKyOP.js";import"./StatusIcon-D9-As4b9.js";import"./CloseButton-DDicOJ3W.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-D7sJR9rS.js";import"./context-B6r7oiwN.js";import"./index-cPHdE-6C.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-C_KtrfhP.js";import"./floating-ui.react-B1qnMOd0.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-lWKxFJo-.js";import"./index-DzN3DWMt.js";import"./index-CFpcu7wG.js";import"./toString-DttkkGgf.js";import"./index-D2JWHt9J.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-rxUVokHK.js";const be=new Date,z=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"mashreq_card"},{label:"ATHEER PLUS",value:"atheer_plus"},{label:"ADCB CARD",value:"adcb_card"},{label:"ADCB BANK",value:"adcb_bank"},{label:"MASHREQ BANK",value:"mashreq_bank"},{label:"OWNER PERSONAL PAY",value:"owner_personal_pay"},{label:"MR.SYED PAY",value:"mr_syed_pay"},{label:"OTHER PAY",value:"other_pay"},{label:"CHEQUE",value:"cheque"},{label:"WIO CARD",value:"wio_card"},{label:"WIO BANK",value:"wio_bank"}],J=d.forwardRef((u,c)=>{const{type:b,initialData:m={billType:"mess",billDate:new Date().toISOString().split("T")[0],shop:"",invoiceNumber:"",amount:"",paymentMethod:"",attachments:[]},onFormSubmit:v,onDiscard:j,onDelete:w}=u,[A,C]=d.useState([]),[P,N]=d.useState(!0),[g,i]=d.useState(!1),[D,E]=d.useState(""),[y,h]=d.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),[k,O]=d.useState(m.attachments||[]),L=d.useCallback(he.debounce(async(o,n=1)=>{var a;try{i(!0);const s=await Y(o,n,y.limit),f=(a=s==null?void 0:s.data)==null?void 0:a.shops.map(t=>({label:t.shopName,value:t._id}));C(n===1?f||[]:t=>[...t,...f||[]]),h(t=>{var r,l,p,x,F,V;return{...t,page:n,total:((l=(r=s==null?void 0:s.data)==null?void 0:r.pagination)==null?void 0:l.total)||0,totalPages:((x=(p=s==null?void 0:s.data)==null?void 0:p.pagination)==null?void 0:x.totalPages)||0,hasMore:n<(((V=(F=s==null?void 0:s.data)==null?void 0:F.pagination)==null?void 0:V.totalPages)||0)}})}catch(s){console.error("Error searching shops:",s)}finally{i(!1)}},500),[y.limit]);d.useEffect(()=>{(async()=>{var n;try{N(!0);const a=await Y("",1,y.limit),s=(n=a==null?void 0:a.data)==null?void 0:n.shops.map(f=>({label:f.shopName,value:f._id}));C(s||[]),h(f=>{var t,r,l,p,x,F;return{...f,total:((r=(t=a==null?void 0:a.data)==null?void 0:t.pagination)==null?void 0:r.total)||0,totalPages:((p=(l=a==null?void 0:a.data)==null?void 0:l.pagination)==null?void 0:p.totalPages)||0,hasMore:1<(((F=(x=a==null?void 0:a.data)==null?void 0:x.pagination)==null?void 0:F.totalPages)||0)}})}catch(a){console.error("Failed to fetch shops:",a)}finally{N(!1)}})()},[]),d.useEffect(()=>{m.attachments&&O(m.attachments)},[m.attachments]);const K=o=>(E(o),L(o,1),o),Q=()=>{if(y.hasMore&&!g){const o=y.page+1;L(D,o)}},W=oe().shape({billDate:I().required("Bill Date is required"),shop:I().required("Shop is required"),paymentMethod:I().required("Payment Method is required"),amount:re().typeError("Amount must be a number").required("Amount is required")}),G=o=>{if(o.target.files&&o.target.files.length>0){const n=Array.from(o.target.files);O(a=>[...a,...n])}},X=o=>{O(n=>n.filter((a,s)=>s!==o))};return e.jsx(se,{innerRef:c,initialValues:{...m,billType:m.billType||"mess",billDate:m.billDate||new Date().toISOString().split("T")[0],shop:m.shopId||m.shop||"",paymentMethod:m.paymentMethod||"",attachments:m.attachments||[],amount:m.amount??""},validationSchema:W,onSubmit:async(o,{setSubmitting:n,setErrors:a})=>{var f;const s=new FormData;s.append("billType",o.billType),s.append("billDate",o.billDate),s.append("shop",o.shop),s.append("paymentMethod",o.paymentMethod),s.append("amount",o.amount.toString()),o.invoiceNumber&&s.append("invoiceNo",o.invoiceNumber),k.forEach((t,r)=>{t instanceof File?s.append("attachments",t):s.append(`existingAttachments[${r}]`,JSON.stringify(t))});try{await v(s,n)}catch(t){n(!1),(f=t.message)!=null&&f.includes("Shop already exists")&&a({shop:"This shop already exists"})}},enableReinitialize:!0,children:({values:o,touched:n,errors:a,isSubmitting:s,setFieldValue:f})=>e.jsx(le,{children:e.jsxs(te,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs($,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(S,{label:"Bill Type",children:e.jsx(M,{name:"billType",children:({field:t,form:r})=>e.jsx(_,{options:[{label:"Mess",value:"mess"}],value:{label:"Mess",value:"mess"},onChange:l=>r.setFieldValue(t.name,l==null?void 0:l.value),isDisabled:b==="edit"})})}),e.jsx(S,{label:"Bill Date",invalid:!!a.billDate&&n.billDate,children:e.jsx(M,{name:"billDate",children:({field:t,form:r})=>e.jsx(ne,{placeholder:"Select billDate Date",value:t.value?new Date(t.value):null,maxDate:be,onChange:l=>r.setFieldValue(t.name,l?ue(new Date(l.getFullYear(),l.getMonth(),l.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(S,{label:"Shop",invalid:!!a.shop&&n.shop,errorMessage:a.shop,children:e.jsx(M,{name:"shop",children:({field:t,form:r})=>{const l=A.find(p=>p.value===t.value)||null;return e.jsx(_,{placeholder:P?"Loading shops...":"Select Shop",options:A,value:l,onChange:p=>r.setFieldValue(t.name,(p==null?void 0:p.value)||""),loading:g,isSearchable:!0,onInputChange:K,inputValue:D,onMenuScrollToBottom:Q,noOptionsMessage:()=>g?"Loading...":"No shops found",loadingMessage:()=>"Loading shops..."})}})}),e.jsx(S,{label:"Payment Method",invalid:!!a.paymentMethod&&n.paymentMethod,errorMessage:a.paymentMethod,children:e.jsx(M,{name:"paymentMethod",children:({field:t,form:r})=>e.jsx(_,{placeholder:"Select Payment Method",options:z,value:z.find(l=>l.value===o.paymentMethod),onChange:l=>r.setFieldValue(t.name,(l==null?void 0:l.value)||"")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(S,{label:"Invoice Number",children:e.jsx(M,{type:"text",autoComplete:"off",name:"invoiceNumber",placeholder:"Invoice Number",component:H})}),e.jsx(S,{label:"Amount",invalid:!!a.amount&&n.amount,errorMessage:a.amount,children:e.jsx(M,{name:"amount",children:({field:t,form:r})=>e.jsx(H,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:l=>r.setFieldValue(t.name,l.target.value)})})})]})]}),e.jsxs($,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(S,{label:"Attachments",children:[e.jsx("input",{type:"file",multiple:!0,onChange:G,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 dark:hover:file:bg-blue-900/20",accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"}),k.length>0&&e.jsx("div",{className:"space-y-2 mt-3",children:k.map((t,r)=>{const l=t instanceof File,p=l?t.name:t.fileName,x=l?void 0:t.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[x?e.jsx("a",{href:x,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:p}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:p}),e.jsx("button",{type:"button",onClick:()=>X(r),className:"text-red-500 hover:text-red-700 ml-2",children:e.jsx(U,{})})]},r)})})]})]})]})}),e.jsxs(ae,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:b==="edit"&&w&&e.jsx(fe,{onDelete:w})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(q,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(q,{size:"sm",variant:"solid",loading:s,icon:e.jsx(ie,{}),type:"submit",children:"Save"})]})]})]})})})});J.displayName="MessBillForm";const fe=({onDelete:u})=>{const[c,b]=d.useState(!1),m=()=>{b(!1),u==null||u(b)},v=()=>{b(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(U,{}),type:"button",onClick:()=>b(!0),children:"Delete"}),e.jsx(me,{isOpen:c,type:"danger",title:"Delete Bill Entry",confirmButtonColor:"red-600",onClose:v,onRequestClose:v,onCancel:v,onConfirm:m,children:e.jsx("p",{children:"Are you sure you want to delete this bill entry?"})})]})},R={billType:"mess",shopName:"",shopNo:"",invoiceNumber:"",paymentMethod:"",amount:"",attachments:[]},bt=()=>{const u=Z(),{id:c}=ee(),[b,m]=d.useState(R);console.log(b,"initialData");const[v,j]=d.useState(!!c),[w,A]=d.useState(null);d.useEffect(()=>{if(!c){m(R),j(!1);return}(async()=>{var g;try{j(!0);const i=await de(c);if(console.log((g=i==null?void 0:i.data)==null?void 0:g.shop,"response"),!(i!=null&&i.data))throw new Error("Invalid bill data received");m({billType:i.data.billType||"mess",shopName:i.data.shop.shopName||"",shopNo:i.data.shop.shopNo||"",shopId:i.data.shop._id||"",invoiceNumber:i.data.invoiceNo||"",paymentMethod:i.data.paymentMethod||"",amount:i.data.amount||"",attachments:i.data.attachments||[]}),A(null)}catch(i){console.error("Error fetching bill:",i),A(i.message||"Failed to load bill data"),T.push(e.jsx(B,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:i.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>u("/app/mess-bill-view"),2500)}finally{j(!1)}})()},[c,u]);const C=async(N,g)=>{var i,D,E,y;try{g(!0);const h=c?await ce(c,N):await pe(N);if([200,201].includes(h.status))T.push(e.jsxs(B,{title:`Successfully ${c?"updated":"added"} mess bill`,type:"success",duration:2500,children:["Mess bill ",c?"updated":"added"," successfully"]}),{placement:"top-center"}),u("/app/mess-bill-view");else throw new Error(((D=(i=h==null?void 0:h.response)==null?void 0:i.data)==null?void 0:D.message)||"Unexpected status code")}catch(h){console.error("Error during form submission:",h),T.push(e.jsx(B,{title:`Error ${c?"updating":"adding"} mess bill`,type:"danger",duration:2500,children:((y=(E=h==null?void 0:h.response)==null?void 0:E.data)==null?void 0:y.message)||h.message}),{placement:"top-center"})}finally{g(!1)}},P=()=>{JSON.stringify(b)!==JSON.stringify(R)?window.confirm("Are you sure you want to discard changes?")&&u("/app/mess-bill-view"):u("/app/mess-bill-view")};return v?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):w?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(B,{title:"Error loading bill",type:"danger",children:w})}):e.jsx(J,{type:c?"edit":"new",initialData:b,onFormSubmit:C,onDiscard:P})};export{bt as default};
