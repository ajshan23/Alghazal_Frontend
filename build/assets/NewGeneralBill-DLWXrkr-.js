import{r as p,j as e,v as ge,a8 as be}from"./index-CZ-QxqVN.js";import{N as R,t as Y}from"./toast-CoCmtbLn.js";import{F as fe,a as y}from"./FormItem-BFRIpM45.js";import{B as z}from"./Button-wTWRjSOp.js";import{S as ye}from"./StickyFooter-K7CPbFFZ.js";import{F as xe,a as ve,b as x}from"./formik.esm-BJAcCTJf.js";import{A as je}from"./index-Dv3L-RrQ.js";import{_ as ae}from"./index-kD3pbGz6.js";import{c as Se,h as Ne,b as C,g as Me,f as ke}from"./index.esm-3ESt5Gw2.js";import"./Alert-vZZK0s39.js";import"./index-DdzAiQaI.js";import"./Badge-M_R8BM5O.js";import{D as Ce}from"./index-WCrMc_mB.js";import"./Card-DYSpZm-g.js";import"./index-Dhhfgcmn.js";import"./Dialog-5Q7WvFhs.js";import"./Drawer-Cgxg1eSD.js";import"./index-BRrKuFuY.js";import"./useUniqueId-BHonA5r7.js";import{I as U}from"./Input-C15wo5ys.js";import"./Upload-CNTsixo0.js";import"./index-Cee-dHef.js";import"./index-CUYy2E4V.js";import"./ScrollBar-CX8t2iP4.js";import{S as q}from"./Select-ukccBfLg.js";import"./Tag-gTkDLVan.js";import{A as L}from"./AdaptableCard-Ce_KsDG0.js";import"./Views-BmihdypO.js";import"./SvgIcon-tuMtLRs6.js";import"./DataTable-C-dnd2Pg.js";import{k as te,l as le,o as we,p as Ae,q as Be}from"./api-CU6E8JBH.js";import{l as se}from"./lodash-CXwz2MO0.js";import{f as Pe}from"./format-CBpsKyOP.js";import"./StatusIcon-D9-As4b9.js";import"./CloseButton-DDicOJ3W.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-D7sJR9rS.js";import"./context-B6r7oiwN.js";import"./index-cPHdE-6C.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-C_KtrfhP.js";import"./floating-ui.react-B1qnMOd0.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-lWKxFJo-.js";import"./index-DzN3DWMt.js";import"./index-CFpcu7wG.js";import"./toString-DttkkGgf.js";import"./index-D2JWHt9J.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-rxUVokHK.js";const ie=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"mashreq_card"},{label:"ATHEER PLUS",value:"atheer_plus"},{label:"ADCB CARD",value:"adcb_card"},{label:"ADCB BANK",value:"adcb_bank"},{label:"MASHREQ BANK",value:"mashreq_bank"},{label:"OWNER PERSONAL PAY",value:"owner_personal_pay"},{label:"MR.SYED PAY",value:"mr_syed_pay"},{label:"OTHER PAY",value:"other_pay"},{label:"CHEQUE",value:"cheque"},{label:"WIO CARD",value:"wio_card"},{label:"WIO BANK",value:"wio_bank"}],Fe=new Date,re=p.forwardRef((v,g)=>{const{type:w,initialData:u={billType:"general",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,category:"",shop:"",invoiceNo:"",remarks:"",attachments:[]},onFormSubmit:$,onDiscard:j,onDelete:A}=v,[M,B]=p.useState([]),[_,S]=p.useState([]),[k,N]=p.useState(!0),[o,P]=p.useState(!1),[F,b]=p.useState(""),[E,K]=p.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),[Q,V]=p.useState([]),[H,W]=p.useState(!1),[J,ne]=p.useState(""),[T,X]=p.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),Z=p.useCallback(se.debounce(async(s,n=1)=>{var r;try{P(!0);const l=await te(s,n,E.limit),d=(r=l==null?void 0:l.data)==null?void 0:r.shops.map(i=>({label:i.shopName,value:i._id}));S(n===1?d||[]:i=>[...i,...d||[]]),K(i=>{var a,c,t,h,m,f;return{...i,page:n,total:((c=(a=l==null?void 0:l.data)==null?void 0:a.pagination)==null?void 0:c.total)||0,totalPages:((h=(t=l==null?void 0:l.data)==null?void 0:t.pagination)==null?void 0:h.totalPages)||0,hasMore:n<(((f=(m=l==null?void 0:l.data)==null?void 0:m.pagination)==null?void 0:f.totalPages)||0)}})}catch(l){console.error("Error searching shops:",l)}finally{P(!1)}},500),[E.limit]),ee=p.useCallback(se.debounce(async(s,n=1)=>{var r;try{W(!0);const l=await le(s,n,T.limit),d=(r=l==null?void 0:l.data)==null?void 0:r.categories.map(i=>({label:i.name,value:i._id}));V(n===1?d||[]:i=>[...i,...d||[]]),X(i=>{var a,c,t,h,m,f;return{...i,page:n,total:((c=(a=l==null?void 0:l.data)==null?void 0:a.pagination)==null?void 0:c.total)||0,totalPages:((h=(t=l==null?void 0:l.data)==null?void 0:t.pagination)==null?void 0:h.totalPages)||0,hasMore:n<(((f=(m=l==null?void 0:l.data)==null?void 0:m.pagination)==null?void 0:f.totalPages)||0)}})}catch(l){console.error("Error searching categories:",l)}finally{W(!1)}},500),[T.limit]);p.useEffect(()=>{u.attachments&&B(u.attachments)},[u]),p.useEffect(()=>{(async()=>{var n,r,l;try{const d=await te("",1,E.limit),i=(n=d==null?void 0:d.data)==null?void 0:n.shops.map(t=>({label:t.shopName,value:t._id}));S(i||[]),K(t=>{var h,m,f,O,D,I;return{...t,total:((m=(h=d==null?void 0:d.data)==null?void 0:h.pagination)==null?void 0:m.total)||0,totalPages:((O=(f=d==null?void 0:d.data)==null?void 0:f.pagination)==null?void 0:O.totalPages)||0,hasMore:1<(((I=(D=d==null?void 0:d.data)==null?void 0:D.pagination)==null?void 0:I.totalPages)||0)}});const a=await le("",1,T.limit),c=(l=(r=a==null?void 0:a.data)==null?void 0:r.categories)==null?void 0:l.map(t=>({label:t.name,value:t._id}));V(c||[]),X(t=>{var h,m,f,O,D,I;return{...t,total:((m=(h=a==null?void 0:a.data)==null?void 0:h.pagination)==null?void 0:m.total)||0,totalPages:((O=(f=a==null?void 0:a.data)==null?void 0:f.pagination)==null?void 0:O.totalPages)||0,hasMore:1<(((I=(D=a==null?void 0:a.data)==null?void 0:D.pagination)==null?void 0:I.totalPages)||0)}})}catch(d){console.error("Failed to load data:",d)}finally{N(!1)}})()},[]);const oe=s=>(b(s),Z(s,1),s),de=()=>{if(E.hasMore&&!o){const s=E.page+1;Z(F,s)}},ce=s=>(ne(s),ee(s,1),s),me=()=>{if(T.hasMore&&!H){const s=T.page+1;ee(J,s)}},pe=Se().shape({billType:C().required("Bill type is required"),billDate:ke().required("Bill date is required").typeError("Please select a valid date"),paymentMethod:C().required("Payment method is required"),amount:Me().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),category:C().required("Category is required"),shop:C().required("Shop is required"),invoiceNo:C(),remarks:C().max(500,"Remarks must be at most 500 characters"),attachments:Ne()}),he=s=>{if(s.target.files&&s.target.files.length>0){const n=Array.from(s.target.files);B(r=>[...r,...n])}},ue=s=>{B(n=>n.filter((r,l)=>l!==s))};return e.jsx(xe,{innerRef:g,initialValues:{billType:u.billType||"general",billDate:u.billDate||"",paymentMethod:u.paymentMethod||"",amount:u.amount||"",category:u.category||"",shop:u.shop||"",invoiceNo:u.invoiceNo||"",remarks:u.remarks||"",attachments:u.attachments||[]},validationSchema:pe,onSubmit:async(s,{setSubmitting:n,setErrors:r})=>{var l,d;try{const i=new FormData;i.append("billType",s.billType),i.append("billDate",s.billDate),i.append("paymentMethod",s.paymentMethod),i.append("amount",s.amount.toString()),i.append("category",s.category),i.append("shop",s.shop),i.append("invoiceNo",s.invoiceNo),i.append("remarks",s.remarks||""),M.forEach((a,c)=>{a instanceof File?i.append("attachments",a):typeof a=="string"&&w==="edit"&&i.append(`existingAttachments[${c}]`,a)}),await $(i,n)}catch(i){n(!1),(d=(l=i.response)==null?void 0:l.data)!=null&&d.errors&&r(i.response.data.errors),console.error("Form submission error:",i)}},enableReinitialize:!0,children:({values:s,touched:n,errors:r,isSubmitting:l,setFieldValue:d,handleBlur:i})=>e.jsx(ve,{children:e.jsxs(fe,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Bill Type",invalid:!!r.billType&&n.billType,errorMessage:r.billType,children:e.jsx(x,{name:"billType",children:({field:a,form:c})=>{const t=[{label:"General",value:"general",disabled:!0}],h=t.find(m=>m.value===a.value)||t[0];return e.jsx(q,{options:t,value:h,isOptionDisabled:m=>m.disabled,onChange:m=>{c.setFieldValue(a.name,m==null?void 0:m.value)},onBlur:a.onBlur,name:a.name})}})}),e.jsx(y,{label:"Bill Date",invalid:!!r.billDate&&n.billDate,children:e.jsx(x,{name:"billDate",children:({field:a,form:c})=>e.jsx(Ce,{placeholder:"Select billDate Date",value:a.value?new Date(a.value):null,maxDate:Fe,onChange:t=>c.setFieldValue(a.name,t?Pe(new Date(t.getFullYear(),t.getMonth(),t.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(y,{label:"Payment Method",invalid:!!r.paymentMethod&&n.paymentMethod,errorMessage:r.paymentMethod,children:e.jsx(x,{name:"paymentMethod",children:({field:a,form:c})=>e.jsx(q,{placeholder:"Select Payment Method",options:ie,value:ie.find(t=>t.value===s.paymentMethod),onChange:t=>{c.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur})})}),e.jsx(y,{label:"Amount",invalid:!!r.amount&&n.amount,errorMessage:r.amount,children:e.jsx(x,{name:"amount",children:({field:a,form:c})=>e.jsx(U,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:t=>{c.setFieldValue(a.name,t.target.value)}})})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(y,{label:"Category",invalid:!!r.category&&n.category,errorMessage:r.category,children:e.jsx(x,{name:"category",children:({field:a,form:c})=>e.jsx(q,{placeholder:"Select Category",options:Q,value:Q.find(t=>t.value===s.category),onChange:t=>{c.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur,loading:H,isSearchable:!0,onInputChange:ce,inputValue:J,onMenuScrollToBottom:me,noOptionsMessage:()=>H?"Loading...":"No categories found",loadingMessage:()=>"Loading categories..."})})}),e.jsx(y,{label:"Shop",invalid:!!r.shop&&n.shop,errorMessage:r.shop,children:e.jsx(x,{name:"shop",children:({field:a,form:c})=>e.jsx(q,{placeholder:"Select Shop",options:_,value:_.find(t=>t.value===s.shop),onChange:t=>{c.setFieldValue(a.name,(t==null?void 0:t.value)||"")},onBlur:a.onBlur,loading:o,isSearchable:!0,onInputChange:oe,inputValue:F,onMenuScrollToBottom:de,noOptionsMessage:()=>o?"Loading...":"No shops found",loadingMessage:()=>"Loading shops..."})})}),e.jsx(y,{label:"Invoice Number",invalid:!!r.invoiceNo&&n.invoiceNo,errorMessage:r.invoiceNo,children:e.jsx(x,{name:"invoiceNo",children:({field:a})=>e.jsx(U,{type:"text",autoComplete:"off",placeholder:"Invoice Number",...a})})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(y,{label:"Attachments",invalid:!!r.attachments&&n.attachments,errorMessage:r.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:he,onBlur:()=>i({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500
                                                file:mr-4 file:py-2 file:px-4
                                                file:rounded-md file:border-0
                                                file:text-sm file:font-semibold
                                                file:bg-blue-50 file:text-blue-700
                                                hover:file:bg-blue-100
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),M.length>0&&e.jsx("div",{className:"space-y-2",children:M.map((a,c)=>{const t=a instanceof File,h=t?a.name:a.fileName,m=t?void 0:a.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[m?e.jsx("a",{href:m,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:h}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:h}),e.jsx("button",{type:"button",onClick:()=>ue(c),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(ae,{})})]},c)})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(y,{label:"Remarks",invalid:!!r.remarks&&n.remarks,errorMessage:r.remarks,children:e.jsx(x,{name:"remarks",children:({field:a})=>e.jsx(U,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...a})})})]})]})}),e.jsxs(ye,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:w==="edit"&&A&&e.jsx(z,{size:"sm",variant:"plain",color:"red",icon:e.jsx(ae,{}),type:"button",onClick:()=>A(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(z,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(z,{size:"sm",variant:"solid",loading:l,icon:e.jsx(je,{}),type:"submit",children:"Save"})]})]})]})})})});re.displayName="GenBillForm";const G={billType:"general",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,category:"",shop:"",invoiceNo:"",remarks:"",attachments:[]},Ba=()=>{const v=ge(),{id:g}=be(),[w,u]=p.useState(G),[$,j]=p.useState(!!g),[A,M]=p.useState(null);p.useEffect(()=>{if(!g){u(G),j(!1);return}(async()=>{var k,N;try{j(!0);const o=await we(g);if(!(o!=null&&o.data))throw new Error("Invalid bill data received");u({billType:o.data.billType||"general",billDate:o.data.billDate||new Date().toISOString().split("T")[0],paymentMethod:o.data.paymentMethod||"",amount:o.data.amount||0,category:((k=o.data.category)==null?void 0:k._id)||o.data.category||"",shop:((N=o.data.shop)==null?void 0:N._id)||o.data.shop||"",invoiceNo:o.data.invoiceNo||"",remarks:o.data.remarks||"",attachments:o.data.attachments||[]}),M(null)}catch(o){console.error("Error fetching bill:",o),M(o.message||"Failed to load bill data"),Y.push(e.jsx(R,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:o.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>v("/app/bill-view"),2500)}finally{j(!1)}})()},[g,v]);const B=async(S,k)=>{var N,o,P,F;try{k(!0);const b=g?await Ae(g,S):await Be(S);if([200,201].includes(b.status))Y.push(e.jsxs(R,{title:`Successfully ${g?"updated":"added"} bill`,type:"success",duration:2500,children:["Bill ",g?"updated":"added"," successfully"]}),{placement:"top-center"}),v("/app/bill-view");else throw new Error(((o=(N=b==null?void 0:b.response)==null?void 0:N.data)==null?void 0:o.message)||"Unexpected status code")}catch(b){console.error("Error during form submission:",b),Y.push(e.jsx(R,{title:`Error ${g?"updating":"adding"} bill`,type:"danger",duration:2500,children:((F=(P=b==null?void 0:b.response)==null?void 0:P.data)==null?void 0:F.message)||b.message}),{placement:"top-center"})}finally{k(!1)}},_=()=>{JSON.stringify(w)!==JSON.stringify(G)?window.confirm("Are you sure you want to discard changes?")&&v("/app/bill-view"):v("/app/bill-view")};return $?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):A?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(R,{title:"Error loading bill",type:"danger",children:A})}):e.jsx(re,{type:g?"edit":"new",initialData:w,onFormSubmit:B,onDiscard:_})};export{Ba as default};
