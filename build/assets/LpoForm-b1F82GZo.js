import{r as x,j as e,a8 as G,v as K,u as W}from"./index-cbxZr22l.js";import{a as h,F as X}from"./FormItem-Dsb0hqaN.js";import{B as f}from"./Button-FHJPdulA.js";import"./useUniqueId-uw_CuIVG.js";import{S as Z}from"./StickyFooter-CtESxEiE.js";import{C as ee}from"./ConfirmDialog-DHHutcW4.js";import{b as S,F as te,a as re}from"./formik.esm-BL5vnelG.js";import{A as se}from"./AdaptableCard-CZjN_iCO.js";import{I as v}from"./Input-CoANB9Wy.js";import"./Alert-CSp5bS7v.js";import"./index-5KOQOspk.js";import"./Badge-DfD0Ukso.js";import{D as ie}from"./index-CpMcTudo.js";import"./Card-RZl4E4-O.js";import"./index-CX5Y9eeL.js";import"./Dialog-OmmgehMy.js";import"./Drawer-Dn9ylrlH.js";import"./index-BM7LESIb.js";import{U as oe}from"./Upload-DyKyTg7Q.js";import"./index-BLEb6Y8m.js";import{t as j,N as y}from"./toast-BCRt4NsN.js";import"./index-B6FuZSSV.js";import"./ScrollBar-B_8Ws9P0.js";import"./Select-DnpJ3Vfh.js";import"./Tag-DRJajbyJ.js";import{_ as C,$ as ae}from"./index-DGePi-hy.js";import{D as ne}from"./DoubleSidedImage-B1HihXG-.js";import{A as le}from"./index-Y8XfetB3.js";import{c as J,e as ce,b as F,g as Y}from"./index.esm-IKt9PIYR.js";import{f as pe,d as me,c as de,u as ue}from"./api-DcXCJsRi.js";import"./context-Ci1lPV1_.js";import"./index-pMPtRiQM.js";import"./proxy-CCW0hh_w.js";import"./toString-DDHIFlh6.js";import"./Views-B4cM7RDw.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-85N_kEkV.js";import"./StatusIcon-CfTAV1XC.js";import"./CloseButton-BgX1UjTO.js";import"./floating-ui.react-CXyQfini.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-DErBkxwa.js";import"./index-DdVDk-x0.js";import"./index-BUmdAIPo.js";import"./chainedFunction-BxZSneMW.js";import"./index-C8fXiORa.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";const he=d=>{const{touched:n,errors:a,values:o,setFieldValue:l,type:I}=d,[g,b]=x.useState([]),P=r=>{if(!r)return null;try{const t=new Date(r);return isNaN(t.getTime())?null:t}catch(t){return console.error("Error converting string to date:",t),null}},w=r=>{if(!r)return"";try{const t=r.getFullYear(),i=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}catch(t){return console.error("Error converting date to string:",t),""}},p=r=>{let t=!0;const i=["application/pdf"],s=10*1024*1024;if(r)for(let c=0;c<r.length;c++){if(!i.includes(r[c].type)){t="Please upload a PDF";break}if(r[c].size>=s){t="File size cannot be more than 10MB!";break}}return t},q=r=>{r.length>0&&(l("documents",[...o.documents,...r]),b(t=>[...t,...r.map(i=>URL.createObjectURL(i))]))},u=(r,t=!1)=>{if(t){const i=[...o.existingDocuments||[]];i.splice(r,1),l("existingDocuments",i)}else{const i=[...o.documents];i.splice(r,1),l("documents",i);const s=[...g];s.splice(r,1),b(s)}},L=()=>{const r=[...o.items,{description:"",quantity:0,unitPrice:0}];l("items",r)},O=r=>{const t=[...o.items];t.splice(r,1),l("items",t)},D=(r,t,i)=>{const s=[...o.items];s[r]={...s[r],[t]:i},l("items",s)};return console.log("LpoFormFields - Current lpoDate value:",o.lpoDate),console.log("LpoFormFields - Converted to Date object:",P(o.lpoDate)),e.jsxs(se,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"LPO Information"}),e.jsx("p",{className:"mb-6",children:"Section to enter LPO details"}),e.jsx(h,{label:"LPO Number",invalid:a.lpoNumber&&n.lpoNumber,errorMessage:a.lpoNumber,children:e.jsx(S,{type:"text",autoComplete:"off",name:"lpoNumber",placeholder:"Enter LPO Number",component:v})}),e.jsx(h,{label:"LPO Date",invalid:a.lpoDate&&n.lpoDate,errorMessage:a.lpoDate,children:e.jsx(S,{name:"lpoDate",children:({field:r,form:t})=>e.jsx(ie,{placeholder:"Select date",value:P(r.value),onChange:i=>{const s=w(i);console.log("DatePicker onChange - Date object:",i),console.log("DatePicker onChange - String value:",s),t.setFieldValue(r.name,s)}})})}),e.jsx(h,{label:"Supplier",invalid:a.supplier&&n.supplier,errorMessage:a.supplier,children:e.jsx(S,{type:"text",autoComplete:"off",name:"supplier",placeholder:"Enter supplier name",component:v})}),e.jsx(h,{label:"Attach Documents",invalid:a.documents&&n.documents,errorMessage:a.documents,children:e.jsxs("div",{children:[e.jsx(oe,{beforeUpload:p,showList:!1,multiple:!0,onChange:q,children:e.jsxs("div",{className:"my-4 text-center",children:[e.jsx(ne,{className:"mx-auto",src:"/img/others/upload.png",darkModeSrc:"/img/others/upload-dark.png"}),e.jsxs("p",{className:"font-semibold",children:[e.jsxs("span",{className:"text-gray-800 dark:text-white",children:["Drop your files here, or"," "]}),e.jsx("span",{className:"text-blue-500",children:"browse"})]}),e.jsx("p",{className:"mt-1 opacity-60 dark:text-white",children:"Support: PDF,(Max 10MB)"})]})}),o.existingDocuments&&o.existingDocuments.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold mb-2",children:"Existing Documents"}),e.jsx("div",{className:"space-y-2",children:o.existingDocuments.map((r,t)=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("a",{href:r.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:underline truncate",children:r.name}),e.jsx(f,{icon:e.jsx(C,{}),variant:"plain",size:"xs",type:"button",onClick:()=>u(t,!0)})]},`existing-${t}`))})]}),o.documents.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h6",{className:"text-sm font-semibold mb-2",children:"New Documents"}),e.jsx("div",{className:"space-y-2",children:o.documents.map((r,t)=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{className:"truncate",children:r.name}),e.jsx(f,{icon:e.jsx(C,{}),variant:"plain",size:"xs",type:"button",onClick:()=>u(t)})]},`new-${t}`))})]})]})}),e.jsx(h,{label:"Items",invalid:a.items&&n.items,errorMessage:a.items,children:e.jsxs("div",{className:"space-y-4",children:[o.items.map((r,t)=>{var i,s,c,m,k,$,E,M,z,A,T,U,R,B,Q,V,_,H;return e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-end border p-4 rounded-lg",children:[e.jsx("div",{className:"col-span-5",children:e.jsx(h,{label:`Item ${t+1} - Description`,className:"mb-0",invalid:((s=(i=a.items)==null?void 0:i[t])==null?void 0:s.description)&&((m=(c=n.items)==null?void 0:c[t])==null?void 0:m.description),errorMessage:($=(k=a.items)==null?void 0:k[t])==null?void 0:$.description,children:e.jsx(v,{type:"text",autoComplete:"off",placeholder:"Item description",value:r.description,onChange:N=>D(t,"description",N.target.value)})})}),e.jsx("div",{className:"col-span-2",children:e.jsx(h,{label:"Quantity",className:"mb-0",invalid:((M=(E=a.items)==null?void 0:E[t])==null?void 0:M.quantity)&&((A=(z=n.items)==null?void 0:z[t])==null?void 0:A.quantity),errorMessage:(U=(T=a.items)==null?void 0:T[t])==null?void 0:U.quantity,children:e.jsx(v,{type:"number",min:"1",autoComplete:"off",placeholder:"Qty",value:r.quantity,onChange:N=>D(t,"quantity",Number(N.target.value))})})}),e.jsx("div",{className:"col-span-3",children:e.jsx(h,{label:"Unit Price",className:"mb-0",invalid:((B=(R=a.items)==null?void 0:R[t])==null?void 0:B.unitPrice)&&((V=(Q=n.items)==null?void 0:Q[t])==null?void 0:V.unitPrice),errorMessage:(H=(_=a.items)==null?void 0:_[t])==null?void 0:H.unitPrice,children:e.jsx(v,{type:"number",min:"0",step:"0.01",autoComplete:"off",placeholder:"Price",value:r.unitPrice,onChange:N=>D(t,"unitPrice",Number(N.target.value))})})}),e.jsx("div",{className:"col-span-2 flex justify-end",children:o.items.length>1&&e.jsx(f,{icon:e.jsx(C,{}),variant:"plain",size:"sm",type:"button",onClick:()=>O(t)})})]},t)}),e.jsx(f,{icon:e.jsx(ae,{}),variant:"plain",size:"sm",type:"button",onClick:L,children:"Add Item"})]})})]})},xe=d=>{if(!d)return"";try{if(d.match(/^\d{4}-\d{2}-\d{2}$/))return d;const n=new Date(d);if(isNaN(n.getTime()))return console.error("Invalid date:",d),"";const a=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),l=String(n.getDate()).padStart(2,"0");return`${a}-${o}-${l}`}catch(n){return console.error("Error formatting date:",n),""}},fe=J().shape({lpoNumber:F().required("LPO Number is required"),lpoDate:F().required("LPO Date is required"),supplier:F().required("Supplier is required"),items:ce().of(J().shape({description:F().required("Description is required"),quantity:Y().required("Quantity is required").min(1,"Quantity must be at least 1"),unitPrice:Y().required("Unit price is required").min(0,"Unit price cannot be negative")})).min(1,"At least one item is required")}),ge=x.forwardRef((d,n)=>{const{lpoId:a,projectId:o}=G(),l=K();W(t=>{var i;return(i=t.auth.user)==null?void 0:i.id});const[I,g]=x.useState(!1),{onDiscard:b}=d,[P,w]=x.useState(!!a),[p,q]=x.useState(a?"edit":"new"),[u,L]=x.useState({id:"",projectId:o||"",lpoNumber:"",lpoDate:"",supplier:"",items:[{description:"",quantity:0,unitPrice:0}],documents:[],existingDocuments:[]});x.useEffect(()=>{if(!o||o.length===0){l("/");return}(async()=>{if(p==="edit"&&a)try{const s=(await pe(o)).data;console.log("Original lpoDate from API:",s.lpoDate);const c=xe(s.lpoDate);console.log("Formatted lpoDate for input:",c),L({id:s._id,projectId:s.project,lpoNumber:s.lpoNumber,lpoDate:c,supplier:s.supplier,items:s.items.map(m=>({description:m.description,quantity:m.quantity,unitPrice:m.unitPrice})),documents:[],existingDocuments:s.documents})}catch(i){console.error("Error fetching LPO data:",i),j.push(e.jsx(y,{title:"Failed to load LPO data",type:"danger"}),{placement:"top-center"}),l(`/app/project-view/${o}`)}finally{w(!1)}else w(!1)})()},[p,a,o,l]);const O=async(t,i)=>{i(!0);try{const s=new FormData;s.append("projectId",t.projectId),s.append("lpoNumber",t.lpoNumber),s.append("lpoDate",t.lpoDate),s.append("supplier",t.supplier),s.append("items",JSON.stringify(t.items)),t.documents.forEach(m=>{s.append("documents",m)}),p==="edit"&&t.existingDocuments&&s.append("existingDocuments",JSON.stringify(t.existingDocuments));let c;p==="new"?(c=await de(s),j.push(e.jsx(y,{title:"LPO created successfully",type:"success"}),{placement:"top-center"})):(c=await ue(t.id,s),j.push(e.jsx(y,{title:"LPO updated successfully",type:"success"}),{placement:"top-center"})),l(`/app/project-view/${o}`)}catch(s){console.error("Error submitting LPO:",s),j.push(e.jsx(y,{title:"Failed to save LPO",type:"danger"}),{placement:"top-center"})}finally{i(!1)}},D=async()=>{try{if(!(u!=null&&u.id))return;await me(u.id),j.push(e.jsx(y,{title:"LPO deleted successfully",type:"success"}),{placement:"top-center"}),l(`/app/project-view/${o}`)}catch{j.push(e.jsx(y,{title:"Failed to delete LPO",type:"danger"}),{placement:"top-center"})}},r=()=>{b?b():l(`/app/project-view/${o}`)};return P?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e.jsx(e.Fragment,{children:e.jsx(te,{innerRef:n,initialValues:u,validationSchema:fe,onSubmit:(t,{setSubmitting:i})=>{O(t,i)},enableReinitialize:!0,children:({values:t,touched:i,errors:s,isSubmitting:c,setFieldValue:m})=>(console.log("Current form lpoDate value:",t.lpoDate),e.jsx(re,{children:e.jsxs(X,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:p==="new"?"Create New LPO":"Edit LPO"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:p==="new"?"Create a new purchase order for the project":"Update the purchase order details"})]}),e.jsx(he,{touched:i,errors:s,values:t,setFieldValue:m,type:p}),e.jsxs(Z,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:p==="edit"&&e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(C,{}),type:"button",onClick:()=>g(!0),children:"Delete"}),e.jsx(ee,{isOpen:I,type:"danger",title:"Delete LPO",confirmButtonColor:"red-600",onClose:()=>g(!1),onRequestClose:()=>g(!1),onCancel:()=>g(!1),onConfirm:D,children:e.jsx("p",{children:"Are you sure you want to delete this LPO? This action cannot be undone."})})]})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(f,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:r,children:"Discard"}),e.jsx(f,{size:"sm",variant:"solid",loading:c,icon:e.jsx(le,{}),type:"submit",children:p==="new"?"Create LPO":"Save Changes"})]})]})]})}))})})});ge.displayName="LpoForm";export{ge as default};
