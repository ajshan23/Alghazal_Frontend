import{r as u,j as e,v as te,a8 as ae}from"./index-cbxZr22l.js";import{N as V,t as q}from"./toast-BCRt4NsN.js";import{m as Y,o as le,p as ie,q as re}from"./api-D4E9hgI-.js";import{F as se,a as g}from"./FormItem-Dsb0hqaN.js";import{B as R}from"./Button-FHJPdulA.js";import{S as ne}from"./StickyFooter-CtESxEiE.js";import{F as oe,a as me,b as y}from"./formik.esm-BL5vnelG.js";import{A as ce}from"./index-Y8XfetB3.js";import{_ as z}from"./index-DGePi-hy.js";import{c as de,h as pe,b as I,g as _,e as ue,f as he}from"./index.esm-IKt9PIYR.js";import"./Alert-CSp5bS7v.js";import"./index-5KOQOspk.js";import"./Badge-DfD0Ukso.js";import{D as be}from"./index-CpMcTudo.js";import"./Card-RZl4E4-O.js";import"./index-CX5Y9eeL.js";import"./Dialog-OmmgehMy.js";import"./Drawer-Dn9ylrlH.js";import"./index-BM7LESIb.js";import"./useUniqueId-uw_CuIVG.js";import{I as B}from"./Input-CoANB9Wy.js";import"./Upload-DyKyTg7Q.js";import"./index-BLEb6Y8m.js";import"./index-B6FuZSSV.js";import"./ScrollBar-B_8Ws9P0.js";import{S as O}from"./Select-DnpJ3Vfh.js";import"./Tag-DRJajbyJ.js";import{A as L}from"./AdaptableCard-CZjN_iCO.js";import"./Views-B4cM7RDw.js";import"./SvgIcon-Bm8Tzw9S.js";import"./DataTable-C4s3mb93.js";import{l as fe}from"./lodash-BUu5cpJG.js";import{f as ge}from"./format-CBpsKyOP.js";import"./StatusIcon-CfTAV1XC.js";import"./CloseButton-BgX1UjTO.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-CCW0hh_w.js";import"./context-Ci1lPV1_.js";import"./index-pMPtRiQM.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-85N_kEkV.js";import"./floating-ui.react-CXyQfini.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-DErBkxwa.js";import"./index-DdVDk-x0.js";import"./index-BUmdAIPo.js";import"./toString-DDHIFlh6.js";import"./index-C8fXiORa.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-C-wX5hDk.js";const ye=new Date,Q=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"mashreq_card"},{label:"ATHEER PLUS",value:"atheer_plus"},{label:"ADCB CARD",value:"adcb_card"},{label:"ADCB BANK",value:"adcb_bank"},{label:"MASHREQ BANK",value:"mashreq_bank"},{label:"OWNER PERSONAL PAY",value:"owner_personal_pay"},{label:"MR.SYED PAY",value:"mr_syed_pay"},{label:"OTHER PAY",value:"other_pay"},{label:"CHEQUE",value:"cheque"},{label:"WIO CARD",value:"wio_card"},{label:"WIO BANK",value:"wio_bank"}],U=u.forwardRef((x,h)=>{const{type:S,initialData:s={billType:"fuel",billDate:new Date().toISOString().split("T")[0],description:"",vehicleNo:[],paymentMethod:"",amount:0,kilometer:0,liter:0,remarks:"",attachments:[]},onFormSubmit:P,onDiscard:j,onDelete:M}=x,[N,w]=u.useState([]),[C,k]=u.useState([]),[A,v]=u.useState(!0),[o,F]=u.useState(!1),[D,b]=u.useState(""),[E,K]=u.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1});u.useEffect(()=>{s.attachments&&w(s.attachments)},[s]);const H=u.useCallback(fe.debounce(async(r,m=1)=>{var a;try{F(!0);const c=await Y(r,m,E.limit),f=(a=c==null?void 0:c.data)==null?void 0:a.vehicles.map(i=>({label:i.vehicleNumber,value:i._id}));k(m===1?f||[]:i=>[...i,...f||[]]),K(i=>{var t,n,l,d,p,T;return{...i,page:m,total:((n=(t=c==null?void 0:c.data)==null?void 0:t.pagination)==null?void 0:n.total)||0,totalPages:((d=(l=c==null?void 0:c.data)==null?void 0:l.pagination)==null?void 0:d.totalPages)||0,hasMore:m<(((T=(p=c==null?void 0:c.data)==null?void 0:p.pagination)==null?void 0:T.totalPages)||0)}})}catch(c){console.error("Error searching vehicles:",c)}finally{F(!1)}},500),[E.limit]);u.useEffect(()=>{(async()=>{var m;try{v(!0);const a=await Y("",1,E.limit),c=(m=a==null?void 0:a.data)==null?void 0:m.vehicles.map(f=>({label:f.vehicleNumber,value:f._id}));k(c||[]),K(f=>{var i,t,n,l,d,p;return{...f,total:((t=(i=a==null?void 0:a.data)==null?void 0:i.pagination)==null?void 0:t.total)||0,totalPages:((l=(n=a==null?void 0:a.data)==null?void 0:n.pagination)==null?void 0:l.totalPages)||0,hasMore:1<(((p=(d=a==null?void 0:a.data)==null?void 0:d.pagination)==null?void 0:p.totalPages)||0)}})}catch(a){console.error("Failed to load vehicles:",a)}finally{v(!1)}})()},[]);const W=r=>(b(r),H(r,1),r),J=()=>{if(E.hasMore&&!o){const r=E.page+1;H(D,r)}},G=de().shape({billType:I().required("Bill type is required"),billDate:he().required("Bill date is required").typeError("Please select a valid date"),description:I().required("Description is required"),vehicles:ue().min(1,"At least one vehicle is required").required("At least one vehicle is required"),paymentMethod:I().required("Payment method is required"),amount:_().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),kilometer:_().required("Kilometer reading is required").positive("Kilometer must be positive").typeError("Kilometer must be a number"),liter:_().required("Liter is required").positive("Liter must be positive").typeError("Liter must be a number"),remarks:I().max(500,"Remarks must be at most 500 characters"),attachments:pe()}),X=r=>{if(r.target.files&&r.target.files.length>0){const m=Array.from(r.target.files);w(a=>[...a,...m])}},Z=r=>{w(m=>m.filter((a,c)=>c!==r))},ee=()=>s.vehicles&&Array.isArray(s.vehicles)?s.vehicles:s.vehicleId?Array.isArray(s.vehicleId)?s.vehicleId:[s.vehicleId]:s.vehicleNo?Array.isArray(s.vehicleNo)?s.vehicleNo:[s.vehicleNo]:[];return e.jsx(oe,{innerRef:h,initialValues:{billType:s.billType||"fuel",billDate:s.billDate||"",description:s.description||"",vehicles:ee(),paymentMethod:s.paymentMethod||"",amount:s.amount||"",kilometer:s.kilometer||"",liter:s.liter||"",remarks:s.remarks||"",attachments:s.attachments||[]},validationSchema:G,onSubmit:async(r,{setSubmitting:m,setErrors:a})=>{var c,f;try{const i=new FormData;i.append("billType",r.billType),i.append("billDate",r.billDate),i.append("description",r.description),Array.isArray(r.vehicles)&&r.vehicles.forEach((t,n)=>{i.append(`vehicles[${n}]`,t)}),i.append("paymentMethod",r.paymentMethod),i.append("amount",r.amount.toString()),i.append("kilometer",r.kilometer.toString()),i.append("liter",r.liter.toString()),i.append("remarks",r.remarks||""),N.forEach((t,n)=>{t instanceof File?i.append("attachments",t):typeof t=="string"&&S==="edit"&&i.append(`existingAttachments[${n}]`,t)}),await P(i,m)}catch(i){m(!1),(f=(c=i.response)==null?void 0:c.data)!=null&&f.errors&&a(i.response.data.errors),console.error("Form submission error:",i)}},enableReinitialize:!0,children:({values:r,touched:m,errors:a,isSubmitting:c,setFieldValue:f,handleBlur:i})=>e.jsx(me,{children:e.jsxs(se,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Fuel Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Bill Type",invalid:!!a.billType&&m.billType,errorMessage:a.billType,children:e.jsx(y,{name:"billType",children:({field:t,form:n})=>{const l=[{label:"Fuel",value:"fuel",disabled:!0}],d=l.find(p=>p.value===t.value)||l[0];return e.jsx(O,{options:l,value:d,isOptionDisabled:p=>p.disabled,onChange:p=>{n.setFieldValue(t.name,p==null?void 0:p.value)},onBlur:t.onBlur,name:t.name})}})}),e.jsx(g,{label:"Bill Date",invalid:!!a.billDate&&m.billDate,children:e.jsx(y,{name:"billDate",children:({field:t,form:n})=>e.jsx(be,{placeholder:"Select bill Date",value:t.value?new Date(t.value):null,maxDate:ye,onChange:l=>n.setFieldValue(t.name,l?ge(new Date(l.getFullYear(),l.getMonth(),l.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(g,{label:"Description",invalid:!!a.description&&m.description,errorMessage:a.description,children:e.jsx(y,{name:"description",children:({field:t})=>e.jsx(B,{type:"text",autoComplete:"off",placeholder:"Description",...t})})}),e.jsx(g,{label:"Vehicles",invalid:!!a.vehicles&&m.vehicles,errorMessage:a.vehicles,children:e.jsx(y,{name:"vehicles",children:({field:t,form:n})=>{const l=C.filter(d=>t.value&&t.value.includes(d.value));return e.jsx(O,{placeholder:A?"Loading vehicles...":"Select Vehicle(s)",options:C,value:l,onChange:d=>{const p=Array.isArray(d)?d.map(T=>T.value):d?[d.value]:[];n.setFieldValue(t.name,p)},onBlur:t.onBlur,loading:o,isSearchable:!0,isMulti:!0,onInputChange:W,inputValue:D,onMenuScrollToBottom:J,noOptionsMessage:()=>o?"Loading...":"No vehicles found",loadingMessage:()=>"Loading vehicles..."})}})}),e.jsx(g,{label:"Payment Method",invalid:!!a.paymentMethod&&m.paymentMethod,errorMessage:a.paymentMethod,children:e.jsx(y,{name:"paymentMethod",children:({field:t,form:n})=>e.jsx(O,{placeholder:"Select Payment Method",options:Q,value:Q.find(l=>l.value===r.paymentMethod),onChange:l=>{n.setFieldValue(t.name,(l==null?void 0:l.value)||"")},onBlur:t.onBlur})})}),e.jsx(g,{label:"Amount",invalid:!!a.amount&&m.amount,errorMessage:a.amount,children:e.jsx(y,{name:"amount",children:({field:t,form:n})=>e.jsx(B,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:l=>{n.setFieldValue(t.name,l.target.value)}})})}),e.jsx(g,{label:"Kilometer",invalid:!!a.kilometer&&m.kilometer,errorMessage:a.kilometer,children:e.jsx(y,{name:"kilometer",children:({field:t,form:n})=>e.jsx(B,{type:"number",autoComplete:"off",placeholder:"Kilometer Reading",...t,onChange:l=>{n.setFieldValue(t.name,l.target.value)}})})}),e.jsx(g,{label:"Liter",invalid:!!a.liter&&m.liter,errorMessage:a.liter,children:e.jsx(y,{name:"liter",children:({field:t,form:n})=>e.jsx(B,{type:"number",autoComplete:"off",placeholder:"Liter",...t,onChange:l=>{n.setFieldValue(t.name,l.target.value)}})})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(g,{label:"Attachments",invalid:!!a.attachments&&m.attachments,errorMessage:a.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:X,onBlur:()=>i({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500
                                                file:mr-4 file:py-2 file:px-4
                                                file:rounded-md file:border-0
                                                file:text-sm file:font-semibold
                                                file:bg-blue-50 file:text-blue-700
                                                hover:file:bg-blue-100
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),N.length>0&&e.jsx("div",{className:"space-y-2",children:N.map((t,n)=>{let l,d;return t instanceof File?l=t.name:typeof t=="object"&&t!==null?(l=t.fileName||t.filePath||"Attachment",d=t._id):typeof t=="string"?l=t:l="Attachment",e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:l}),e.jsx("button",{type:"button",onClick:()=>Z(n),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(z,{})})]},d||n)})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(g,{label:"Remarks",invalid:!!a.remarks&&m.remarks,errorMessage:a.remarks,children:e.jsx(y,{name:"remarks",children:({field:t})=>e.jsx(B,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...t})})})]})]})}),e.jsxs(ne,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:S==="edit"&&M&&e.jsx(R,{size:"sm",variant:"plain",color:"red",icon:e.jsx(z,{}),type:"button",onClick:()=>M(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(R,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(R,{size:"sm",variant:"solid",loading:c,icon:e.jsx(ce,{}),type:"submit",children:"Save"})]})]})]})})})});U.displayName="FuelBillForm";const $={billType:"fuel",billDate:new Date().toISOString().split("T")[0],paymentMethod:"",amount:0,description:"",vehicleNo:"",kilometer:0,liter:0,remarks:"",attachments:[]},ft=()=>{const x=te(),{id:h}=ae(),[S,s]=u.useState($),[P,j]=u.useState(!!h),[M,N]=u.useState(null);u.useEffect(()=>{if(!h){s($),j(!1);return}(async()=>{var A,v;try{j(!0);const o=await le(h);if(!(o!=null&&o.data))throw new Error("Invalid bill data received");s({billType:o.data.billType||"fuel",billDate:o.data.billDate||new Date().toISOString().split("T")[0],paymentMethod:o.data.paymentMethod||"",amount:o.data.amount||0,description:o.data.description||"",vehicleNo:((A=o.data.vehicle)==null?void 0:A.vehicleNumber)||"",vehicleId:((v=o.data.vehicle)==null?void 0:v._id)||"",kilometer:o.data.kilometer||0,liter:o.data.liter||0,remarks:o.data.remarks||"",attachments:o.data.attachments||[]}),N(null)}catch(o){console.error("Error fetching bill:",o),N(o.message||"Failed to load bill data"),q.push(e.jsx(V,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:o.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>x("/app/fuel-bill-view"),2500)}finally{j(!1)}})()},[h,x]);const w=async(k,A)=>{var v,o,F,D;try{A(!0);const b=h?await ie(h,k):await re(k);if([200,201].includes(b.status))q.push(e.jsxs(V,{title:`Successfully ${h?"updated":"added"} fuel bill`,type:"success",duration:2500,children:["Fuel bill ",h?"updated":"added"," successfully"]}),{placement:"top-center"}),x("/app/fuel-bill-view");else throw new Error(((o=(v=b==null?void 0:b.response)==null?void 0:v.data)==null?void 0:o.message)||"Unexpected status code")}catch(b){console.error("Error during form submission:",b),q.push(e.jsx(V,{title:`Error ${h?"updating":"adding"} fuel bill`,type:"danger",duration:2500,children:((D=(F=b==null?void 0:b.response)==null?void 0:F.data)==null?void 0:D.message)||b.message}),{placement:"top-center"})}finally{A(!1)}},C=()=>{JSON.stringify(S)!==JSON.stringify($)?window.confirm("Are you sure you want to discard changes?")&&x("/app/fuel-bill-view"):x("/app/fuel-bill-view")};return P?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):M?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(V,{title:"Error loading fuel bill",type:"danger",children:M})}):e.jsx(U,{type:h?"edit":"new",initialData:S,onFormSubmit:w,onDiscard:C})};export{ft as default};
