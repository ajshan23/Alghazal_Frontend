import{r as m,j as e,v as he,a8 as ue}from"./index-CZ-QxqVN.js";import{N as D,t as J}from"./toast-CoCmtbLn.js";import{F as ge,a as C}from"./FormItem-BFRIpM45.js";import{B as U}from"./Button-wTWRjSOp.js";import{S as fe}from"./StickyFooter-K7CPbFFZ.js";import{F as xe,a as be,b as B}from"./formik.esm-BJAcCTJf.js";import{A as ye}from"./index-Dv3L-RrQ.js";import{_ as Y}from"./index-kD3pbGz6.js";import{c as je,h as ve,b as H,g as Se,f as Ne}from"./index.esm-3ESt5Gw2.js";import"./Alert-vZZK0s39.js";import"./index-DdzAiQaI.js";import"./Badge-M_R8BM5O.js";import{D as we}from"./index-WCrMc_mB.js";import"./Card-DYSpZm-g.js";import"./index-Dhhfgcmn.js";import"./Dialog-5Q7WvFhs.js";import"./Drawer-Cgxg1eSD.js";import"./index-BRrKuFuY.js";import"./useUniqueId-BHonA5r7.js";import{I as Z}from"./Input-C15wo5ys.js";import"./Upload-CNTsixo0.js";import"./index-Cee-dHef.js";import"./index-CUYy2E4V.js";import"./ScrollBar-CX8t2iP4.js";import{S as ee}from"./Select-ukccBfLg.js";import"./Tag-gTkDLVan.js";import{A as _}from"./AdaptableCard-Ce_KsDG0.js";import"./Views-BmihdypO.js";import"./SvgIcon-tuMtLRs6.js";import"./DataTable-C-dnd2Pg.js";import{k as te,l as ae,B as ke,C as Ce,D as Ae}from"./api-CU6E8JBH.js";import{l as re}from"./lodash-CXwz2MO0.js";import"./StatusIcon-D9-As4b9.js";import"./CloseButton-DDicOJ3W.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-D7sJR9rS.js";import"./context-B6r7oiwN.js";import"./index-cPHdE-6C.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-C_KtrfhP.js";import"./floating-ui.react-B1qnMOd0.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-lWKxFJo-.js";import"./index-DzN3DWMt.js";import"./index-CFpcu7wG.js";import"./toString-DttkkGgf.js";import"./index-D2JWHt9J.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-rxUVokHK.js";const Fe=new Date,se=m.forwardRef((S,u)=>{const{type:L,initialData:g={reportDate:new Date,amount:0,category:"",shop:"",remarks:"",attachments:[]},onFormSubmit:$,onDiscard:N,onDelete:A}=S,[F,P]=m.useState([]),[T,f]=m.useState([]),[y,j]=m.useState(!0),[c,E]=m.useState(!1),[k,p]=m.useState(!1),[w,v]=m.useState(""),[z,oe]=m.useState(""),[M,G]=m.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),[O,K]=m.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),[V,Q]=m.useState(g.attachments||[]),W=m.useCallback(re.debounce(async(n,s=1)=>{var l;try{E(!0);const t=await te(n,s,M.limit),x=(l=t==null?void 0:t.data)==null?void 0:l.shops.map(a=>({label:a.shopName,value:a._id}));P(s===1?x||[]:a=>[...a,...x||[]]),G(a=>{var r,o,d,i,h,b;return{...a,page:s,total:((o=(r=t==null?void 0:t.data)==null?void 0:r.pagination)==null?void 0:o.total)||0,totalPages:((i=(d=t==null?void 0:t.data)==null?void 0:d.pagination)==null?void 0:i.totalPages)||0,hasMore:s<(((b=(h=t==null?void 0:t.data)==null?void 0:h.pagination)==null?void 0:b.totalPages)||0)}})}catch(t){console.error("Error searching shops:",t)}finally{E(!1)}},500),[M.limit]),X=m.useCallback(re.debounce(async(n,s=1)=>{var l;try{p(!0);const t=await ae(n,s,O.limit),x=(l=t==null?void 0:t.data)==null?void 0:l.categories.map(a=>({label:a.name,value:a._id}));f(s===1?x||[]:a=>[...a,...x||[]]),K(a=>{var r,o,d,i,h,b;return{...a,page:s,total:((o=(r=t==null?void 0:t.data)==null?void 0:r.pagination)==null?void 0:o.total)||0,totalPages:((i=(d=t==null?void 0:t.data)==null?void 0:d.pagination)==null?void 0:i.totalPages)||0,hasMore:s<(((b=(h=t==null?void 0:t.data)==null?void 0:h.pagination)==null?void 0:b.totalPages)||0)}})}catch(t){console.error("Error searching categories:",t)}finally{p(!1)}},500),[O.limit]);m.useEffect(()=>{(async()=>{var s,l;try{j(!0);const t=await te("",1,M.limit),x=(s=t==null?void 0:t.data)==null?void 0:s.shops.map(o=>({label:o.shopName,value:o._id}));P(x||[]),G(o=>{var d,i,h,b,I,R;return{...o,total:((i=(d=t==null?void 0:t.data)==null?void 0:d.pagination)==null?void 0:i.total)||0,totalPages:((b=(h=t==null?void 0:t.data)==null?void 0:h.pagination)==null?void 0:b.totalPages)||0,hasMore:1<(((R=(I=t==null?void 0:t.data)==null?void 0:I.pagination)==null?void 0:R.totalPages)||0)}});const a=await ae("",1,O.limit),r=(l=a==null?void 0:a.data)==null?void 0:l.categories.map(o=>({label:o.name,value:o._id}));f(r||[]),K(o=>{var d,i,h,b,I,R;return{...o,total:((i=(d=a==null?void 0:a.data)==null?void 0:d.pagination)==null?void 0:i.total)||0,totalPages:((b=(h=a==null?void 0:a.data)==null?void 0:h.pagination)==null?void 0:b.totalPages)||0,hasMore:1<(((R=(I=a==null?void 0:a.data)==null?void 0:I.pagination)==null?void 0:R.totalPages)||0)}})}catch(t){console.error("Failed to load data:",t)}finally{j(!1)}})()},[]);const ie=n=>(v(n),W(n,1),n),ne=()=>{if(M.hasMore&&!c){const n=M.page+1;W(w,n)}},le=n=>(oe(n),X(n,1),n),ce=()=>{if(O.hasMore&&!k){const n=O.page+1;X(z,n)}},de=n=>{if(n.target.files&&n.target.files.length>0){const s=Array.from(n.target.files);Q(l=>[...l,...s])}},me=n=>{Q(s=>s.filter((l,t)=>t!==n))},pe=je().shape({reportDate:Ne().required("Bill date is required").typeError("Please select a valid date"),amount:Se().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),category:H().required("Category is required"),shop:H().required("Shop is required"),remarks:H().max(500,"Remarks must be at most 500 characters"),attachments:ve()});return e.jsx(xe,{innerRef:u,initialValues:{reportDate:g.reportDate instanceof Date?g.reportDate:new Date(g.reportDate),amount:g.amount||"",category:g.category||"",shop:g.shop||"",remarks:g.remarks||"",attachments:g.attachments||[]},validationSchema:pe,onSubmit:async(n,{setSubmitting:s,setErrors:l})=>{var t,x;try{const a={...n,attachments:V};await $(a,s)}catch(a){s(!1),(x=(t=a.response)==null?void 0:t.data)!=null&&x.errors&&l(a.response.data.errors),console.error("Form submission error:",a)}},enableReinitialize:!0,children:({values:n,touched:s,errors:l,isSubmitting:t,setFieldValue:x,handleBlur:a})=>e.jsx(be,{children:e.jsxs(ge,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(_,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"ADIB Report Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(C,{label:"Bill Date",invalid:!!l.reportDate&&s.reportDate,children:e.jsx(B,{name:"reportDate",children:({field:r,form:o})=>e.jsx(we,{placeholder:"Select Bill Date",value:r.value?new Date(r.value):null,maxDate:Fe,onChange:d=>o.setFieldValue(r.name,d||null)})})}),e.jsx(C,{label:"Amount",invalid:!!l.amount&&s.amount,errorMessage:l.amount,children:e.jsx(B,{name:"amount",children:({field:r,form:o})=>e.jsx(Z,{type:"number",autoComplete:"off",placeholder:"Amount",...r,onChange:d=>{o.setFieldValue(r.name,d.target.value)}})})})]})]}),e.jsxs(_,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(C,{label:"Category",invalid:!!l.category&&s.category,errorMessage:l.category,children:e.jsx(B,{name:"category",children:({field:r,form:o})=>{const d=T.find(i=>i.value===r.value)||null;return e.jsx(ee,{placeholder:y?"Loading categories...":"Select Category",options:T,value:d,onChange:i=>{o.setFieldValue(r.name,(i==null?void 0:i.value)||"")},loading:k,isSearchable:!0,onInputChange:le,inputValue:z,onMenuScrollToBottom:ce,noOptionsMessage:()=>k?"Loading...":"No categories found",loadingMessage:()=>"Loading categories..."})}})}),e.jsx(C,{label:"Shop Name",invalid:!!l.shop&&s.shop,errorMessage:l.shop,children:e.jsx(B,{name:"shop",children:({field:r,form:o})=>{const d=F.find(i=>i.value===r.value)||null;return e.jsx(ee,{placeholder:y?"Loading shops...":"Select Shop",options:F,value:d,onChange:i=>{o.setFieldValue(r.name,(i==null?void 0:i.value)||"")},loading:c,isSearchable:!0,onInputChange:ie,inputValue:w,onMenuScrollToBottom:ne,noOptionsMessage:()=>c?"Loading...":"No shops found",loadingMessage:()=>"Loading shops..."})}})})]})]}),e.jsxs(_,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(C,{label:"Remarks",invalid:!!l.remarks&&s.remarks,errorMessage:l.remarks,children:e.jsx(B,{name:"remarks",children:({field:r})=>e.jsx(Z,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...r})})})]}),e.jsxs(_,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(C,{label:"Attachments",invalid:!!l.attachments&&s.attachments,errorMessage:l.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:de,onBlur:()=>a({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500
                                                file:mr-4 file:py-2 file:px-4
                                                file:rounded-md file:border-0
                                                file:text-sm file:font-semibold
                                                file:bg-blue-50 file:text-blue-700
                                                hover:file:bg-blue-100
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),V.length>0&&e.jsx("div",{className:"space-y-2",children:V.map((r,o)=>{const d=r instanceof File,i=d?r.name:r.fileName,h=d?void 0:r.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[h?e.jsx("a",{href:h,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:i}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:i}),e.jsx("button",{type:"button",onClick:()=>me(o),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(Y,{})})]},o)})})]})]})]})}),e.jsxs(fe,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:L==="edit"&&A&&e.jsx(U,{size:"sm",variant:"plain",color:"red",icon:e.jsx(Y,{}),type:"button",onClick:()=>A(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(U,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>N==null?void 0:N(),children:"Discard"}),e.jsx(U,{size:"sm",variant:"solid",loading:t,icon:e.jsx(ye,{}),type:"submit",children:"Save"})]})]})]})})})});se.displayName="AdibReportForm";const q={reportDate:new Date().toISOString().split("T")[0],amount:"",category:"",shop:"",remarks:"",attachments:[]},kt=()=>{const S=he(),{id:u}=ue(),[L,g]=m.useState(q),[$,N]=m.useState(!!u),[A,F]=m.useState(null);m.useEffect(()=>{if(!u){g(q),N(!1);return}(async()=>{var y,j;try{N(!0);const c=await ke(u);if(!(c!=null&&c.data))throw new Error("Invalid report data received");g({reportDate:c.data.reportDate||q.reportDate,amount:c.data.amount||"",category:((y=c.data.category)==null?void 0:y._id)||c.data.category||"",shop:((j=c.data.shop)==null?void 0:j._id)||c.data.shop||"",remarks:c.data.remarks||"",attachments:c.data.attachments||[]}),F(null)}catch(c){console.error("Error fetching report:",c),F(c.message||"Failed to load report data"),J.push(e.jsx(D,{title:"Failed to fetch Aadib report data",type:"danger",duration:2500,children:c.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>S("/app/aadib-report-view"),2500)}finally{N(!1)}})()},[u,S]);const P=async(f,y)=>{var j,c,E,k;try{y(!0);const p=new FormData;p.append("reportType","adib"),Object.keys(f).forEach(v=>{v!=="attachments"&&p.append(v,f[v])}),f.attachments&&f.attachments.length>0&&f.attachments.forEach((v,z)=>{v instanceof File&&p.append("attachments",v)}),f.reportDate instanceof Date&&p.set("reportDate",f.reportDate.toISOString());const w=u?await Ce(u,p):await Ae(p);if([200,201].includes(w.status))J.push(e.jsxs(D,{title:`Successfully ${u?"updated":"added"} Aadib report`,type:"success",duration:2500,children:["Aadib report ",u?"updated":"added"," successfully"]}),{placement:"top-center"}),S("/app/adib-report-view");else throw new Error(((c=(j=w==null?void 0:w.response)==null?void 0:j.data)==null?void 0:c.message)||"Unexpected status code")}catch(p){console.error("Error during form submission:",p),J.push(e.jsx(D,{title:`Error ${u?"updating":"adding"} Aadib report`,type:"danger",duration:2500,children:((k=(E=p==null?void 0:p.response)==null?void 0:E.data)==null?void 0:k.message)||p.message}),{placement:"top-center"})}finally{y(!1)}},T=()=>{JSON.stringify(L)!==JSON.stringify(q)?window.confirm("Are you sure you want to discard changes?")&&S("/app/aadib-report-view"):S("/app/aadib-report-view")};return $?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):A?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(D,{title:"Error loading Aadib report",type:"danger",children:A})}):e.jsx(se,{type:u?"edit":"new",initialData:L,onFormSubmit:P,onDiscard:T})};export{kt as default};
