import{r as h,j as e,v as ie,a8 as se}from"./index-CZ-QxqVN.js";import{N as T,t as I}from"./toast-CoCmtbLn.js";import{k as Q,m as re,o as oe,p as ne,q as ce}from"./api-CU6E8JBH.js";import{F as me,a as f}from"./FormItem-BFRIpM45.js";import{B as q}from"./Button-wTWRjSOp.js";import{S as de}from"./StickyFooter-K7CPbFFZ.js";import{F as pe,a as he,b as g}from"./formik.esm-BJAcCTJf.js";import{A as ue}from"./index-Dv3L-RrQ.js";import{_ as U}from"./index-kD3pbGz6.js";import{c as be,h as ve,b as M,g as fe,e as ge,f as ye}from"./index.esm-3ESt5Gw2.js";import"./Alert-vZZK0s39.js";import"./index-DdzAiQaI.js";import"./Badge-M_R8BM5O.js";import{D as xe}from"./index-WCrMc_mB.js";import"./Card-DYSpZm-g.js";import"./index-Dhhfgcmn.js";import"./Dialog-5Q7WvFhs.js";import"./Drawer-Cgxg1eSD.js";import"./index-BRrKuFuY.js";import"./useUniqueId-BHonA5r7.js";import{I as O}from"./Input-C15wo5ys.js";import"./Upload-CNTsixo0.js";import"./index-Cee-dHef.js";import"./index-CUYy2E4V.js";import"./ScrollBar-CX8t2iP4.js";import{S as _}from"./Select-ukccBfLg.js";import"./Tag-gTkDLVan.js";import{A as R}from"./AdaptableCard-Ce_KsDG0.js";import"./Views-BmihdypO.js";import"./SvgIcon-tuMtLRs6.js";import"./DataTable-C-dnd2Pg.js";import{l as je}from"./lodash-CXwz2MO0.js";import{f as Ne}from"./format-CBpsKyOP.js";import"./StatusIcon-D9-As4b9.js";import"./CloseButton-DDicOJ3W.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-D7sJR9rS.js";import"./context-B6r7oiwN.js";import"./index-cPHdE-6C.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-C_KtrfhP.js";import"./floating-ui.react-B1qnMOd0.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-lWKxFJo-.js";import"./index-DzN3DWMt.js";import"./index-CFpcu7wG.js";import"./toString-DttkkGgf.js";import"./index-D2JWHt9J.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-rxUVokHK.js";const Se=new Date,W=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"mashreq_card"},{label:"ATHEER PLUS",value:"atheer_plus"},{label:"ADCB CARD",value:"adcb_card"},{label:"ADCB BANK",value:"adcb_bank"},{label:"MASHREQ BANK",value:"mashreq_bank"},{label:"OWNER PERSONAL PAY",value:"owner_personal_pay"},{label:"MR.SYED PAY",value:"mr_syed_pay"},{label:"OTHER PAY",value:"other_pay"},{label:"CHEQUE",value:"cheque"},{label:"WIO CARD",value:"wio_card"},{label:"WIO BANK",value:"wio_bank"}],J=h.forwardRef((x,v)=>{const{type:w,initialData:d={billType:"vehicle",billDate:new Date().toISOString().split("T")[0],purpose:"",vehicles:[],invoiceNo:"",paymentMethod:"",amount:0,shop:{_id:"",shopName:"",shopNo:""},remarks:"",attachments:[]},onFormSubmit:V,onDiscard:j,onDelete:k}=x,[N,A]=h.useState([]),[P,D]=h.useState([]),[u,c]=h.useState([]),[F,B]=h.useState(!0),[S,b]=h.useState(!1),[$,G]=h.useState(""),[E,H]=h.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),Y=h.useCallback(je.debounce(async(s,n=1)=>{var i;try{b(!0);const r=await Q(s,n,E.limit),y=(i=r==null?void 0:r.data)==null?void 0:i.shops.map(t=>({label:t.shopName,value:t._id}));c(n===1?y||[]:t=>[...t,...y||[]]),H(t=>{var a,o,l,m,p,C;return{...t,page:n,total:((o=(a=r==null?void 0:r.data)==null?void 0:a.pagination)==null?void 0:o.total)||0,totalPages:((m=(l=r==null?void 0:r.data)==null?void 0:l.pagination)==null?void 0:m.totalPages)||0,hasMore:n<(((C=(p=r==null?void 0:r.data)==null?void 0:p.pagination)==null?void 0:C.totalPages)||0)}})}catch(r){console.error("Error searching shops:",r)}finally{b(!1)}},500),[E.limit]);h.useEffect(()=>{d.attachments&&A(d.attachments)},[d]),h.useEffect(()=>{(async()=>{var n,i;try{B(!0);const r=await re(),y=(n=r==null?void 0:r.data)==null?void 0:n.vehicles.map(o=>({label:o.vehicleNumber,value:o._id}));D(y||[]);const t=await Q("",1,E.limit),a=(i=t==null?void 0:t.data)==null?void 0:i.shops.map(o=>({label:o.shopName,value:o._id}));c(a||[]),H(o=>{var l,m,p,C,z,K;return{...o,total:((m=(l=t==null?void 0:t.data)==null?void 0:l.pagination)==null?void 0:m.total)||0,totalPages:((C=(p=t==null?void 0:t.data)==null?void 0:p.pagination)==null?void 0:C.totalPages)||0,hasMore:1<(((K=(z=t==null?void 0:t.data)==null?void 0:z.pagination)==null?void 0:K.totalPages)||0)}})}catch(r){console.error("Failed to load data:",r)}finally{B(!1)}})()},[]);const X=s=>(G(s),Y(s,1),s),Z=()=>{if(E.hasMore&&!S){const s=E.page+1;Y($,s)}},ee=be().shape({billType:M().required("Bill type is required"),billDate:ye().required("Bill date is required").typeError("Please select a valid date"),purpose:M().required("Purpose is required"),vehicles:ge().of(M()).min(1,"At least one vehicle must be selected").required("Vehicle selection is required"),paymentMethod:M().required("Payment method is required"),amount:fe().required("Amount is required").positive("Amount must be positive").typeError("Amount must be a number"),shop:M().required("Shop is required"),remarks:M().max(500,"Remarks must be at most 500 characters"),attachments:ve()}),ae=s=>{if(s.target.files&&s.target.files.length>0){const n=Array.from(s.target.files);A(i=>[...i,...n])}},te=s=>{A(n=>n.filter((i,r)=>r!==s))},le=()=>({billType:d.billType,billDate:d.billDate,purpose:d.purpose,vehicles:d.vehicles.map(s=>s._id),invoiceNo:d.invoiceNo,paymentMethod:d.paymentMethod,amount:d.amount,shop:d.shop._id,remarks:d.remarks,attachments:d.attachments});return e.jsx(pe,{innerRef:v,initialValues:le(),validationSchema:ee,onSubmit:async(s,{setSubmitting:n,setErrors:i})=>{var r,y;try{const t=new FormData;t.append("billType",s.billType),t.append("billDate",s.billDate),t.append("purpose",s.purpose),s.vehicles.forEach(a=>{t.append("vehicles[]",a)}),t.append("invoiceNo",s.invoiceNo),t.append("paymentMethod",s.paymentMethod),t.append("amount",s.amount.toString()),t.append("shop",s.shop),t.append("remarks",s.remarks||""),N.forEach((a,o)=>{a instanceof File?t.append("attachments",a):typeof a=="string"&&w==="edit"&&t.append(`existingAttachments[${o}]`,a)}),await V(t,n)}catch(t){n(!1),(y=(r=t.response)==null?void 0:r.data)!=null&&y.errors&&i(t.response.data.errors),console.error("Form submission error:",t)}},enableReinitialize:!0,children:({values:s,touched:n,errors:i,isSubmitting:r,setFieldValue:y,handleBlur:t})=>e.jsx(he,{children:e.jsxs(me,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Vehicle Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(f,{label:"Bill Type",invalid:!!i.billType&&n.billType,errorMessage:i.billType,children:e.jsx(g,{name:"billType",children:({field:a,form:o})=>{const l=[{label:"Vehicle",value:"vehicle",disabled:!0}],m=l.find(p=>p.value===a.value)||l[0];return e.jsx(_,{options:l,value:m,isOptionDisabled:p=>p.disabled,onChange:p=>{o.setFieldValue(a.name,p==null?void 0:p.value)},onBlur:a.onBlur,name:a.name})}})}),e.jsx(f,{label:"Bill Date",invalid:!!i.billDate&&n.billDate,children:e.jsx(g,{name:"billDate",children:({field:a,form:o})=>e.jsx(xe,{placeholder:"Select billDate Date",value:a.value?new Date(a.value):null,maxDate:Se,onChange:l=>o.setFieldValue(a.name,l?Ne(new Date(l.getFullYear(),l.getMonth(),l.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(f,{label:"Purpose",invalid:!!i.purpose&&n.purpose,errorMessage:i.purpose,children:e.jsx(g,{name:"purpose",children:({field:a})=>e.jsx(O,{type:"text",autoComplete:"off",placeholder:"Purpose",...a})})}),e.jsx(f,{label:"Vehicle",invalid:!!i.vehicles&&n.vehicles,errorMessage:i.vehicles,children:e.jsx(g,{name:"vehicles",children:({field:a,form:o})=>e.jsx(_,{placeholder:"Select Vehicle(s)",options:P,isMulti:!0,value:P.filter(l=>s.vehicles.includes(l.value)),onChange:l=>{const m=l?l.map(p=>p.value):[];o.setFieldValue(a.name,m)},onBlur:a.onBlur,loading:F})})}),e.jsx(f,{label:"Invoice No",invalid:!!i.invoiceNo&&n.invoiceNo,errorMessage:i.invoiceNo,children:e.jsx(g,{name:"invoiceNo",children:({field:a})=>e.jsx(O,{type:"text",autoComplete:"off",placeholder:"Invoice number",...a})})}),e.jsx(f,{label:"Payment Method",invalid:!!i.paymentMethod&&n.paymentMethod,errorMessage:i.paymentMethod,children:e.jsx(g,{name:"paymentMethod",children:({field:a,form:o})=>e.jsx(_,{placeholder:"Select Payment Method",options:W,value:W.find(l=>l.value===s.paymentMethod),onChange:l=>{o.setFieldValue(a.name,(l==null?void 0:l.value)||"")},onBlur:a.onBlur})})}),e.jsx(f,{label:"Amount",invalid:!!i.amount&&n.amount,errorMessage:i.amount,children:e.jsx(g,{name:"amount",children:({field:a,form:o})=>e.jsx(O,{type:"number",autoComplete:"off",placeholder:"Amount",...a,onChange:l=>{o.setFieldValue(a.name,l.target.value)}})})}),e.jsx(f,{label:"Shop",invalid:!!i.shop&&n.shop,errorMessage:i.shop,children:e.jsx(g,{name:"shop",children:({field:a,form:o})=>{const l=u.find(m=>m.value===a.value)||null;return e.jsx(_,{placeholder:F?"Loading shops...":"Select Shop",options:u,value:l,onChange:m=>o.setFieldValue(a.name,(m==null?void 0:m.value)||""),loading:S,isSearchable:!0,onInputChange:X,inputValue:$,onMenuScrollToBottom:Z,noOptionsMessage:()=>S?"Loading...":"No shops found",loadingMessage:()=>"Loading shops..."})}})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(f,{label:"Attachments",invalid:!!i.attachments&&n.attachments,errorMessage:i.attachments,children:[e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"file",multiple:!0,onChange:ae,onBlur:()=>t({target:{name:"attachments"}}),className:`block w-full text-sm text-gray-500
                                                file:mr-4 file:py-2 file:px-4
                                                file:rounded-md file:border-0
                                                file:text-sm file:font-semibold
                                                file:bg-blue-50 file:text-blue-700
                                                hover:file:bg-blue-100
                                                dark:file:bg-blue-900/30 dark:file:text-blue-300
                                                dark:hover:file:bg-blue-900/20`,accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"})}),N.length>0&&e.jsx("div",{className:"space-y-2",children:N.map((a,o)=>{let l,m;return a instanceof File?l=a.name:typeof a=="object"&&a!==null?(l=a.fileName||a.filePath||"Attachment",m=a._id):typeof a=="string"?l=a:l="Attachment",e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:l}),e.jsx("button",{type:"button",onClick:()=>te(o),className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 ml-2",children:e.jsx(U,{})})]},m||o)})})]})]}),e.jsxs(R,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(f,{label:"Remarks",invalid:!!i.remarks&&n.remarks,errorMessage:i.remarks,children:e.jsx(g,{name:"remarks",children:({field:a})=>e.jsx(O,{as:"textarea",autoComplete:"off",placeholder:"Enter any remarks",...a})})})]})]})}),e.jsxs(de,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:w==="edit"&&k&&e.jsx(q,{size:"sm",variant:"plain",color:"red",icon:e.jsx(U,{}),type:"button",onClick:()=>k(()=>{}),children:"Delete"})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(q,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>j==null?void 0:j(),children:"Discard"}),e.jsx(q,{size:"sm",variant:"solid",loading:r,icon:e.jsx(ue,{}),type:"submit",children:"Save"})]})]})]})})})});J.displayName="VehicleBillForm";const L={billType:"vehicle",billDate:new Date().toISOString().split("T")[0],purpose:"",vehicles:[],invoiceNo:"",paymentMethod:"",amount:0,shop:{_id:"",shopName:"",shopNo:""},remarks:"",attachments:[]},ja=()=>{const x=ie(),{id:v}=se(),[w,d]=h.useState(L),[V,j]=h.useState(!!v),[k,N]=h.useState(null);h.useEffect(()=>{if(!v){d(L),j(!1);return}(async()=>{try{j(!0);const u=await oe(v);if(!(u!=null&&u.data))throw new Error("Invalid bill data received");const{data:c}=u;d({billType:c.billType||"vehicle",billDate:c.billDate?c.billDate.split("T")[0]:new Date().toISOString().split("T")[0],purpose:c.purpose||"",vehicles:c.vehicles||[],invoiceNo:c.invoiceNo||"",paymentMethod:c.paymentMethod||"",amount:c.amount||0,shop:c.shop||{_id:"",shopName:"",shopNo:""},remarks:c.remarks||"",attachments:c.attachments||[]}),N(null)}catch(u){console.error("Error fetching bill:",u),N(u.message||"Failed to load bill data"),I.push(e.jsx(T,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:u.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>x("/app/vehicle-bill-view"),2500)}finally{j(!1)}})()},[v,x]);const A=async(D,u)=>{var c,F,B,S;try{u(!0);const b=v?await ne(v,D):await ce(D);if([200,201].includes(b.status))I.push(e.jsxs(T,{title:`Successfully ${v?"updated":"added"} vehicle bill`,type:"success",duration:2500,children:["Vehicle bill ",v?"updated":"added"," successfully"]}),{placement:"top-center"}),x("/app/vehicle-bill-view");else throw new Error(((F=(c=b==null?void 0:b.response)==null?void 0:c.data)==null?void 0:F.message)||"Unexpected status code")}catch(b){console.error("Error during form submission:",b),I.push(e.jsx(T,{title:`Error ${v?"updating":"adding"} vehicle bill`,type:"danger",duration:2500,children:((S=(B=b==null?void 0:b.response)==null?void 0:B.data)==null?void 0:S.message)||b.message}),{placement:"top-center"})}finally{u(!1)}},P=()=>{JSON.stringify(w)!==JSON.stringify(L)?window.confirm("Are you sure you want to discard changes?")&&x("/app/vehicle-bill-view"):x("/app/vehicle-bill-view")};return V?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(T,{title:"Error loading vehicle bill",type:"danger",children:k})}):e.jsx(J,{type:v?"edit":"new",initialData:w,onFormSubmit:A,onDiscard:P})};export{ja as default};
