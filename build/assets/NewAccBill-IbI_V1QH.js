import{r as c,j as e,v as Z,a8 as ee}from"./index-CZ-QxqVN.js";import{N as I,t as _}from"./toast-CoCmtbLn.js";import{F as ae,a as g}from"./FormItem-BFRIpM45.js";import{B as V}from"./Button-wTWRjSOp.js";import{S as te}from"./StickyFooter-K7CPbFFZ.js";import{F as oe,a as se,b as y}from"./formik.esm-BJAcCTJf.js";import{A as le}from"./index-Dv3L-RrQ.js";import{_ as U}from"./index-kD3pbGz6.js";import{c as re,g as ie,b as D}from"./index.esm-3ESt5Gw2.js";import"./Alert-vZZK0s39.js";import"./index-DdzAiQaI.js";import"./Badge-M_R8BM5O.js";import{D as ne}from"./index-WCrMc_mB.js";import"./Card-DYSpZm-g.js";import"./index-Dhhfgcmn.js";import"./Dialog-5Q7WvFhs.js";import"./Drawer-Cgxg1eSD.js";import"./index-BRrKuFuY.js";import"./useUniqueId-BHonA5r7.js";import{I as E}from"./Input-C15wo5ys.js";import"./Upload-CNTsixo0.js";import"./index-Cee-dHef.js";import"./index-CUYy2E4V.js";import"./ScrollBar-CX8t2iP4.js";import{S as q}from"./Select-ukccBfLg.js";import"./Tag-gTkDLVan.js";import{A as L}from"./AdaptableCard-Ce_KsDG0.js";import"./Views-BmihdypO.js";import"./SvgIcon-tuMtLRs6.js";import{C as me}from"./ConfirmDialog-m53FmWqq.js";import"./DataTable-C-dnd2Pg.js";import{k as Y,o as de,p as ce,q as pe}from"./api-CU6E8JBH.js";import{l as he}from"./lodash-CXwz2MO0.js";import{f as ue}from"./format-CBpsKyOP.js";import"./StatusIcon-D9-As4b9.js";import"./CloseButton-DDicOJ3W.js";import"./chainedFunction-BxZSneMW.js";import"./proxy-D7sJR9rS.js";import"./context-B6r7oiwN.js";import"./index-cPHdE-6C.js";import"./cloneDeep-DJN0yfLA.js";import"./hoist-non-react-statics.cjs-C_KtrfhP.js";import"./floating-ui.react-B1qnMOd0.js";import"./floating-ui.dom-B_iSk-nO.js";import"./_getPrototype-lWKxFJo-.js";import"./index-DzN3DWMt.js";import"./index-CFpcu7wG.js";import"./toString-DttkkGgf.js";import"./index-D2JWHt9J.js";import"./defineProperty-DRmM3rRU.js";import"./typeof-QjJsDpFa.js";import"./useThemeClass-rxUVokHK.js";const fe=new Date,z=[{label:"ADVANCE",value:"advance"},{label:"ADIB",value:"adib"},{label:"Cash",value:"cash"},{label:"MASHREQ CARD",value:"mashreq_card"},{label:"ATHEER PLUS",value:"atheer_plus"},{label:"ADCB CARD",value:"adcb_card"},{label:"ADCB BANK",value:"adcb_bank"},{label:"MASHREQ BANK",value:"mashreq_bank"},{label:"OWNER PERSONAL PAY",value:"owner_personal_pay"},{label:"MR.SYED PAY",value:"mr_syed_pay"},{label:"OTHER PAY",value:"other_pay"},{label:"CHEQUE",value:"cheque"},{label:"WIO CARD",value:"wio_card"},{label:"WIO BANK",value:"wio_bank"}],J=c.forwardRef((u,p)=>{const{type:b,initialData:n={billType:"accommodation",date:new Date().toISOString().split("T")[0],shopName:"",roomNo:"",invoiceNumber:"",amount:"",paymentMethod:"",note:"",remarks:"",attachments:[]},onFormSubmit:S,onDiscard:A,onDelete:C}=u,[M,k]=c.useState([]),[P,w]=c.useState(!0),[x,N]=c.useState(!1),[r,B]=c.useState(""),[j,h]=c.useState({page:1,limit:30,total:0,totalPages:0,hasMore:!1}),[R,T]=c.useState(n.attachments||[]),H=c.useCallback(he.debounce(async(s,m=1)=>{var o;try{N(!0);const a=await Y(s,m,j.limit),f=(o=a==null?void 0:a.data)==null?void 0:o.shops.map(t=>({label:t.shopName,value:t._id}));k(m===1?f||[]:t=>[...t,...f||[]]),h(t=>{var i,l,d,v,F,$;return{...t,page:m,total:((l=(i=a==null?void 0:a.data)==null?void 0:i.pagination)==null?void 0:l.total)||0,totalPages:((v=(d=a==null?void 0:a.data)==null?void 0:d.pagination)==null?void 0:v.totalPages)||0,hasMore:m<((($=(F=a==null?void 0:a.data)==null?void 0:F.pagination)==null?void 0:$.totalPages)||0)}})}catch(a){console.error("Error searching shops:",a)}finally{N(!1)}},500),[j.limit]);c.useEffect(()=>{(async()=>{var m;try{w(!0);const o=await Y("",1,j.limit),a=(m=o==null?void 0:o.data)==null?void 0:m.shops.map(f=>({label:f.shopName,value:f._id}));k(a||[]),h(f=>{var t,i,l,d,v,F;return{...f,total:((i=(t=o==null?void 0:o.data)==null?void 0:t.pagination)==null?void 0:i.total)||0,totalPages:((d=(l=o==null?void 0:o.data)==null?void 0:l.pagination)==null?void 0:d.totalPages)||0,hasMore:1<(((F=(v=o==null?void 0:o.data)==null?void 0:v.pagination)==null?void 0:F.totalPages)||0)}})}catch(o){console.error("Failed to fetch shops:",o)}finally{w(!1)}})()},[]),c.useEffect(()=>{n.attachments&&T(n.attachments)},[n.attachments]);const K=s=>(B(s),H(s,1),s),Q=()=>{if(j.hasMore&&!x){const s=j.page+1;H(r,s)}},W=re().shape({date:D().required("Date is required"),shopName:D().required("Shop Name is required"),roomNo:D().required("Room No is required"),paymentMethod:D().required("Payment Method is required"),amount:ie().typeError("Amount must be a number").required("Amount is required")}),G=s=>{if(s.target.files&&s.target.files.length>0){const m=Array.from(s.target.files);T(o=>[...o,...m])}},X=s=>{T(m=>m.filter((o,a)=>a!==s))};return e.jsx(oe,{innerRef:p,initialValues:{...n,billType:n.billType||"accommodation",date:n.date||new Date().toISOString().split("T")[0],shopName:n.shopName||"",shopId:n.shopId||"",roomNo:n.roomNo||"",paymentMethod:n.paymentMethod||"",note:n.note||"",remarks:n.remarks||"",attachments:n.attachments||[],amount:n.amount??""},validationSchema:W,onSubmit:async(s,{setSubmitting:m,setErrors:o})=>{var f;const a=new FormData;a.append("billType",s.billType),a.append("billDate",s.date),a.append("shopName",s.shopName),s.shopId&&a.append("shop",s.shopId),a.append("roomNo",s.roomNo),a.append("paymentMethod",s.paymentMethod),a.append("amount",s.amount.toString()),s.invoiceNumber&&a.append("invoiceNo",s.invoiceNumber),s.note&&a.append("note",s.note),s.remarks&&a.append("remarks",s.remarks),R.forEach((t,i)=>{t instanceof File?a.append("attachments",t):a.append(`existingAttachments[${i}]`,JSON.stringify(t))});try{await S(a,m)}catch(t){m(!1),(f=t.message)!=null&&f.includes("Shop already exists")&&o({shopName:"This shop already exists"})}},enableReinitialize:!0,children:({values:s,touched:m,errors:o,isSubmitting:a,setFieldValue:f})=>e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:e.jsxs("div",{className:"lg:col-span-2",children:[e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Accommodation Bill Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Bill Type",children:e.jsx(y,{name:"billType",children:({field:t,form:i})=>e.jsx(q,{options:[{label:"Accommodation",value:"accommodation"}],value:{label:"Accommodation",value:"accommodation"},onChange:l=>i.setFieldValue(t.name,l==null?void 0:l.value),isDisabled:b==="edit"})})}),e.jsx(g,{label:"Bill Date",invalid:!!o.date&&m.date,children:e.jsx(y,{name:"date",children:({field:t,form:i})=>e.jsx(ne,{placeholder:"Select bill Date",value:t.value?new Date(t.value):null,maxDate:fe,onChange:l=>i.setFieldValue(t.name,l?ue(new Date(l.getFullYear(),l.getMonth(),l.getDate()),"yyyy-MM-dd"):"")})})}),e.jsx(g,{label:"Shop Name",invalid:!!o.shopName&&m.shopName,errorMessage:o.shopName,children:e.jsx(y,{name:"shopName",children:({field:t,form:i})=>{const l=M.find(d=>d.label===t.value)||null;return e.jsx(q,{placeholder:P?"Loading shops...":"Select Shop",options:M,value:l,onChange:d=>{i.setFieldValue(t.name,(d==null?void 0:d.label)||""),i.setFieldValue("shopId",(d==null?void 0:d.value)||"")},loading:x,isSearchable:!0,onInputChange:K,inputValue:r,onMenuScrollToBottom:Q,noOptionsMessage:()=>x?"Loading...":"No shops found",loadingMessage:()=>"Loading shops..."})}})}),e.jsx(g,{label:"Room No",invalid:!!o.roomNo&&m.roomNo,errorMessage:o.roomNo,children:e.jsx(y,{type:"text",autoComplete:"off",name:"roomNo",placeholder:"Room No",component:E})}),e.jsx(g,{label:"Payment Method",invalid:!!o.paymentMethod&&m.paymentMethod,errorMessage:o.paymentMethod,children:e.jsx(y,{name:"paymentMethod",children:({field:t,form:i})=>e.jsx(q,{placeholder:"Select Payment Method",options:z,value:z.find(l=>l.value===s.paymentMethod),onChange:l=>i.setFieldValue(t.name,(l==null?void 0:l.value)||"")})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(g,{label:"Invoice Number",children:e.jsx(y,{type:"text",autoComplete:"off",name:"invoiceNumber",placeholder:"Invoice Number",component:E})}),e.jsx(g,{label:"Amount",invalid:!!o.amount&&m.amount,errorMessage:o.amount,children:e.jsx(y,{name:"amount",children:({field:t,form:i})=>e.jsx(E,{type:"number",autoComplete:"off",placeholder:"Amount",...t,onChange:l=>i.setFieldValue(t.name,l.target.value)})})})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsx(g,{label:"Note",children:e.jsx(y,{as:"textarea",autoComplete:"off",name:"note",placeholder:"Note",component:E,textArea:!0})})})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Attachments"}),e.jsxs(g,{label:"Attachments",children:[e.jsx("input",{type:"file",multiple:!0,onChange:G,className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-300 dark:hover:file:bg-blue-900/20",accept:".pdf,.jpg,.jpeg,.png,.doc,.docx"}),R.length>0&&e.jsx("div",{className:"space-y-2 mt-3",children:R.map((t,i)=>{const l=t instanceof File,d=l?t.name:t.fileName,v=l?void 0:t.filePath;return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[v?e.jsx("a",{href:v,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 dark:text-blue-300 truncate hover:underline",children:d}):e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300 truncate",children:d}),e.jsx("button",{type:"button",onClick:()=>X(i),className:"text-red-500 hover:text-red-700 ml-2",children:e.jsx(U,{})})]},i)})})]})]}),e.jsxs(L,{divider:!0,className:"mb-4",children:[e.jsx("h5",{className:"mb-4",children:"Remarks"}),e.jsx(g,{label:"Remarks",children:e.jsx(y,{as:"textarea",autoComplete:"off",name:"remarks",placeholder:"Remarks",component:E,textArea:!0})})]})]})}),e.jsxs(te,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:b==="edit"&&C&&e.jsx(be,{onDelete:C})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(V,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>A==null?void 0:A(),children:"Discard"}),e.jsx(V,{size:"sm",variant:"solid",loading:a,icon:e.jsx(le,{}),type:"submit",children:"Save"})]})]})]})})})});J.displayName="AccBillForm";const be=({onDelete:u})=>{const[p,b]=c.useState(!1),n=()=>{b(!1),u==null||u(b)},S=()=>{b(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(U,{}),type:"button",onClick:()=>b(!0),children:"Delete"}),e.jsx(me,{isOpen:p,type:"danger",title:"Delete Accommodation Bill",confirmButtonColor:"red-600",onClose:S,onRequestClose:S,onCancel:S,onConfirm:n,children:e.jsx("p",{children:"Are you sure you want to delete this accommodation bill?"})})]})},O={billType:"accommodation",date:new Date().toISOString().split("T")[0],shopName:"",roomNo:"",invoiceNumber:"",paymentMethod:"",amount:"",note:"",remarks:"",attachments:[]},fa=()=>{const u=Z(),{id:p}=ee(),[b,n]=c.useState(O),[S,A]=c.useState(!!p),[C,M]=c.useState(null);c.useEffect(()=>{if(!p){n(O),A(!1);return}(async()=>{var x,N;try{A(!0);const r=await de(p);if(!(r!=null&&r.data))throw new Error("Invalid bill data received");n({billType:r.data.billType||"accommodation",date:r.data.date||O.date,shopName:((x=r.data.shop)==null?void 0:x.shopName)||"",roomNo:r.data.roomNo||"",shopId:((N=r.data.shop)==null?void 0:N._id)||"",invoiceNumber:r.data.invoiceNo||"",paymentMethod:r.data.paymentMethod||"",amount:r.data.amount||"",note:r.data.note||"",remarks:r.data.remarks||"",attachments:r.data.attachments||[]}),M(null)}catch(r){console.error("Error fetching bill:",r),M(r.message||"Failed to load bill data"),_.push(e.jsx(I,{title:"Failed to fetch bill data",type:"danger",duration:2500,children:r.message||"Something went wrong"}),{placement:"top-center"}),setTimeout(()=>u("/app/acc-bill-view"),2500)}finally{A(!1)}})()},[p,u]);const k=async(w,x)=>{var N,r,B,j;try{x(!0);const h=p?await ce(p,w):await pe(w);if([200,201].includes(h.status))_.push(e.jsxs(I,{title:`Successfully ${p?"updated":"added"} accommodation bill`,type:"success",duration:2500,children:["Accommodation bill ",p?"updated":"added"," successfully"]}),{placement:"top-center"}),u("/app/acc-bill-view");else throw new Error(((r=(N=h==null?void 0:h.response)==null?void 0:N.data)==null?void 0:r.message)||"Unexpected status code")}catch(h){console.error("Error during form submission:",h),_.push(e.jsx(I,{title:`Error ${p?"updating":"adding"} accommodation bill`,type:"danger",duration:2500,children:((j=(B=h==null?void 0:h.response)==null?void 0:B.data)==null?void 0:j.message)||h.message}),{placement:"top-center"})}finally{x(!1)}},P=()=>{JSON.stringify(b)!==JSON.stringify(O)?window.confirm("Are you sure you want to discard changes?")&&u("/app/acc-bill-view"):u("/app/acc-bill-view")};return S?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(I,{title:"Error loading bill",type:"danger",children:C})}):e.jsx(J,{type:p?"edit":"new",initialData:b,onFormSubmit:k,onDiscard:P})};export{fa as default};
